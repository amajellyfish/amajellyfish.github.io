<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="false"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="en">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  
    <title> &middot; David Thomas</title>
    <meta name="title" content=" &middot; David Thomas">
  

  
  
  
  
  
  <link rel="canonical" href="http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-7---inventories/">
  

  
  
    <meta name="author" content="David Thomas">
  
  

  
  <meta property="og:url" content="http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-7---inventories/">
  <meta property="og:site_name" content="David Thomas">
  <meta property="og:title" content="David Thomas">
  <meta property="og:description" content="Chapter 7 - Inventories # Earlier in the book, a basic inventory file example was given (see Chapter 1’s basic inventory file example). For the simplest of purposes, an inventory file at the default location (/etc/ansible/hosts) will suffice to describe to Ansible how to reach the servers you want to manage.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="tech-notes">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="David Thomas">
  <meta name="twitter:description" content="Chapter 7 - Inventories # Earlier in the book, a basic inventory file example was given (see Chapter 1’s basic inventory file example). For the simplest of purposes, an inventory file at the default location (/etc/ansible/hosts) will suffice to describe to Ansible how to reach the servers you want to manage.">

  
  
  
  
    
      
    
  
    
      
    
  
    
      
    
  
  
    
  

  
  
  
  
  
  

  

  
  
  
  
  
  
  
    
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.c5c4ab59b36e3a06d6dff38478af5d2c18b2d7a3603611d7fc5647b02111f989bd5957610b6bed4d10718428186bc7c38590e84c77c0d50f401da78f4fbb5384.css"
    integrity="sha512-xcSrWbNuOgbW3/OEeK9dLBiy16NgNhHX/FZHsCER&#43;Ym9WVdhC2vtTRBxhCgYa8fDhZDoTHfA1Q9AHaePT7tThA==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js"
    integrity="sha512-b0EXSzoFtoCCD&#43;CMrb&#43;l&#43;3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script>
  
  
  
  
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
  
    
  
  
    
  
  
    
  
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js"
      integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP&#43;pSqMXxm6JPOUeAg=="
      data-copy="Copy"
      data-copied="Copied"></script>
  

  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>


























  

  

  

  

  





  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "",
    "headline": "",
    
    "abstract": "\u003ch2 class=\u0022relative group\u0022\u003eChapter 7 - Inventories\n    \u003cdiv id=\u0022chapter-7---inventories\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#chapter-7---inventories\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cp\u003eEarlier in the book, a basic inventory file example was given (see\nChapter 1\u0026rsquo;s \u003ca\n  href=\u0022#chap03.xhtml_basic-inventory\u0022\u003ebasic inventory file\nexample\u003c\/a\u003e). For the simplest of purposes,\nan inventory file at the default location (\u003ccode\u003e\/etc\/ansible\/hosts\u003c\/code\u003e) will\nsuffice to describe to Ansible how to reach the servers you want to\nmanage.\u003c\/p\u003e",
    "inLanguage": "en",
    "url" : "http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-7---inventories/",
    "author" : {
      "@type": "Person",
      "name": "David Thomas"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "5804"
  }]
  </script>



  
  

  
  

  
  

  
  
    
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
      <script>

    const firebaseConfig = {
      apiKey: "AIzaSyApsKLCbGb5fkkrzxABOtl3-OUuBcRPVsc",
      authDomain: "davidwrites-89dd7.firebaseapp.com",
      projectId: "davidwrites-89dd7",
      storageBucket: "davidwrites-89dd7.firebasestorage.app",
      messagingSenderId: "433139099634",
      appId: "1:433139099634:web:c14275555bd7171e6c6d6b",
      measurementId: "G-XX5507B82W"
    };

        var app = firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var auth = firebase.auth();

      </script>
    
  

  
  
</head>







  
    
  







  
    
  






  
  
  <body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        Skip to main content
      </a>
    </div>
    
    
      













<div
  class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0">
  
  
    
    

  <div class="flex flex-1 items-center justify-between">
    <nav class="flex space-x-3">
      
        <a href="/" class="text-base font-medium">
          David Thomas
        </a>
      
    </nav>
    
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">
    
      
        
  <a
  href="/tech-notes/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Tech Notes"
  title="">
  
  
    <p class="text-base font-medium">
      Tech Notes
    </p>
  
</a>



      
        
  <a
  href="/notes/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Notes"
  title="Book Notes &amp; Reviews">
  
  
    <p class="text-base font-medium">
      Notes
    </p>
  
</a>



      
        
  <a
  href="/articles/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Articles"
  title="Articles">
  
  
    <p class="text-base font-medium">
      Articles
    </p>
  
</a>



      
        
  <a
  href="/now/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Now"
  title="Now">
  
  
    <p class="text-base font-medium">
      Now
    </p>
  
</a>



      
        
  <a
  href=""
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  
  title="">
  
  
</a>



      
    

    

    

    
      <button
        id="search-button"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </nav>

    
  <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">
    <span></span>

    

    

    
      <button
        id="search-button-mobile"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </div>

  </div>
  
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]">
          <ul
            class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
              </span>
            </li>

            
              
  <li class="mt-1">
  <a
    href="/tech-notes/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Tech Notes"
    title="">
    
    
      <p class="text-bg font-bg">
        Tech Notes
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/notes/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Notes"
    title="Book Notes &amp; Reviews">
    
    
      <p class="text-bg font-bg">
        Notes
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/articles/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Articles"
    title="Articles">
    
    
      <p class="text-bg font-bg">
        Articles
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/now/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Now"
    title="Now">
    
    
      <p class="text-bg font-bg">
        Now
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href=""
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    
    title="">
    
    
  </a>
</li>



            

          </ul>
          
        </div>
      
    </div>
  </div>

</div>




  <script>
    (function () {
      var $mainmenu = $(".main-menu");
      var path = window.location.pathname;
      $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
        $(e).children("p").addClass("active");
      });
    })();
  </script>


    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  
    
  

  

  
    
  

  

  

  

  
    
  

  
    
  

  
    
  

  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="0001-01-01T00:00:00&#43;00:00">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span
    id="views_tech notes/RHCE/Ansible4Devops/Chapter 7 - Inventories.md"
    class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400"
    title="views"
    >loading</span
  >
  <span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
<path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span>
<span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span
    id="likes_tech notes/RHCE/Ansible4Devops/Chapter 7 - Inventories.md"
    class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400"
    title="likes"
    >loading</span
  >
  <span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span>
</span>
<span class="px-2 text-primary-500">&middot;</span><span>
  <button
    id="button_likes"
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    <span id="button_likes_heart" class="inline-block align-text-bottom hidden"
      ><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span>
    </span>
    <span id="button_likes_emtpty_heart" class="inline-block align-text-bottom"
      ><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M244 84L255.1 96L267.1 84.02C300.6 51.37 347 36.51 392.6 44.1C461.5 55.58 512 115.2 512 185.1V190.9C512 232.4 494.8 272.1 464.4 300.4L283.7 469.1C276.2 476.1 266.3 480 256 480C245.7 480 235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1 0 232.4 0 190.9V185.1C0 115.2 50.52 55.58 119.4 44.1C164.1 36.51 211.4 51.37 244 84C243.1 84 244 84.01 244 84L244 84zM255.1 163.9L210.1 117.1C188.4 96.28 157.6 86.4 127.3 91.44C81.55 99.07 48 138.7 48 185.1V190.9C48 219.1 59.71 246.1 80.34 265.3L256 429.3L431.7 265.3C452.3 246.1 464 219.1 464 190.9V185.1C464 138.7 430.4 99.07 384.7 91.44C354.4 86.4 323.6 96.28 301.9 117.1L255.1 163.9z"/></svg></span></span
    >
    <span id="button_likes_text">&nbsp;Like</span>
  </button>
</span>
    

    
    
  </div>

  

  
  

  
  



      </div>
      
        
  
  
  
  
  
  

  

  

  

  

      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky lg:top-10">
            
              <details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#chapter-7---inventories">Chapter 7 - Inventories</a>
      <ul>
        <li><a href="#chap09.xhtml_leanpub-auto-a-real-world-web-application-server-inventory">A real-world web application server inventory</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-non-prod-environments-separate-inventory-files">Non-prod environments, separate inventory files</a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-inventory-variables">Inventory variables</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-hostvars"><code>host_vars</code></a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-groupvars"><code>group_vars</code></a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-ephemeral-infrastructure-dynamic-inventory">Ephemeral infrastructure: Dynamic inventory</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-dynamic-inventory-with-digitalocean">Dynamic inventory with DigitalOcean</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-dynamic-inventory-with-aws">Dynamic inventory with AWS</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-inventory-on-the-fly-addhost-and-groupby">Inventory on-the-fly: <code>add_host</code> and <code>group_by</code></a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-multiple-inventory-sources---mixing-static-and-dynamic-inventories">Multiple inventory sources - mixing static and dynamic inventories</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-creating-custom-dynamic-inventories">Creating custom dynamic inventories</a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-summary-6">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#chapter-7---inventories">Chapter 7 - Inventories</a>
      <ul>
        <li><a href="#chap09.xhtml_leanpub-auto-a-real-world-web-application-server-inventory">A real-world web application server inventory</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-non-prod-environments-separate-inventory-files">Non-prod environments, separate inventory files</a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-inventory-variables">Inventory variables</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-hostvars"><code>host_vars</code></a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-groupvars"><code>group_vars</code></a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-ephemeral-infrastructure-dynamic-inventory">Ephemeral infrastructure: Dynamic inventory</a>
          <ul>
            <li><a href="#chap09.xhtml_leanpub-auto-dynamic-inventory-with-digitalocean">Dynamic inventory with DigitalOcean</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-dynamic-inventory-with-aws">Dynamic inventory with AWS</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-inventory-on-the-fly-addhost-and-groupby">Inventory on-the-fly: <code>add_host</code> and <code>group_by</code></a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-multiple-inventory-sources---mixing-static-and-dynamic-inventories">Multiple inventory sources - mixing static and dynamic inventories</a></li>
            <li><a href="#chap09.xhtml_leanpub-auto-creating-custom-dynamic-inventories">Creating custom dynamic inventories</a></li>
          </ul>
        </li>
        <li><a href="#chap09.xhtml_leanpub-auto-summary-6">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>


<script>
  (function () {
    'use strict'

    const SCROLL_OFFSET_RATIO = 0.33
    const TOC_SELECTOR = '#TableOfContents'
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false

    function getActiveAnchorId(anchors, offsetRatio) {
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...document.querySelectorAll('#TableOfContents a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => link.getAttribute('href').substring(1)))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      for (let i = anchors.length - 1; i >= 0; i--) {
        const top = anchors[i].getBoundingClientRect().top + window.scrollY
        if (top <= threshold && tocIds.has(anchors[i].id)) {
          return anchors[i].id
        }
      }
      return anchors.find(anchor => tocIds.has(anchor.id))?.id || ''
    }

    function updateTOC({ toc, anchors, links, scrollOffset, collapseInactive }) {
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) return

      links.forEach(link => {
        const isActive = link.getAttribute('href') === `#${activeId}`
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        let el = activeLink
        while (el && el !== toc) {
          if (el.tagName === 'UL') el.style.display = ''
          if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
          el = el.parentElement
        }
      }
    }

    function initTOC() {
      const toc = document.querySelector(TOC_SELECTOR)
      if (!toc) return

      const collapseInactive = true
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
        })
      })

      const config = {
        toc,
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      window.addEventListener('scroll', () => updateTOC(config), { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      updateTOC(config)
    }

    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', initTOC)
      : initTOC()
  })()
</script>


            
          </div>
        </div>
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          
<h2 class="relative group">Chapter 7 - Inventories
    <div id="chapter-7---inventories" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chapter-7---inventories" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>Earlier in the book, a basic inventory file example was given (see
Chapter 1&rsquo;s <a
  href="#chap03.xhtml_basic-inventory">basic inventory file
example</a>). For the simplest of purposes,
an inventory file at the default location (<code>/etc/ansible/hosts</code>) will
suffice to describe to Ansible how to reach the servers you want to
manage.</p>
<p>Later, a slightly more involved inventory file was introduced (see
Chapter 3&rsquo;s <a
  href="#chap05.xhtml_multiple-server-inventory">inventory file for multiple
servers</a>), which allowed us to
tell Ansible about multiple servers, and even group them into
role-related groups, so we could run certain playbooks against certain
groups.</p>
<p>Let&rsquo;s jump back to a basic inventory file example and build from there:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 # Inventory file at /etc/ansible/hosts
2 
3 # Groups are defined using square brackets (e.g. [groupname]). Each server
4 # in the group is defined on its own line.
5 [myapp]
6 www.myapp.com</code></pre>
</div>
</figure>
<p>If you want to run an ansible playbook on all the <code>myapp</code> servers in
this inventory (so far, just one, <code>www.myapp.com</code>), you can set up the
playbook like so:</p>
<figure class="code">
<div class="highlight">
<pre><code>---
- hosts: myapp
<p>tasks:
[&hellip;]</code></pre></p>
</div>
</figure>
<p>If you want to run an ad-hoc command against all the <code>myapp</code> servers in
the inventory, you can run a command like so:</p>
<figure class="code">
<div class="highlight">
<pre><code># Use ansible to check memory usage on all the myapp servers.
$ ansible myapp -a &quot;free -m&quot;</code></pre>
</div>
</figure>

<h3 class="relative group">A real-world web application server inventory
    <div id="chap09xhtml_leanpub-auto-a-real-world-web-application-server-inventory" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-a-real-world-web-application-server-inventory" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>The example above might be adequate for single-server services and tiny
apps or websites, but most real-world applications require many more
servers, and usually separate servers per application concern (database,
caching, application, queuing, etc.). Let&rsquo;s take a look at a real-world
inventory file for a small web application that monitors server uptime,
<a
  href="https://servercheck.in/"
    target="_blank"
  >Server Check.in</a>.</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 # Individual Server Check.in servers.
 2 [servercheck-web]
 3 www1.servercheck.in
 4 www2.servercheck.in
 5 
 6 [servercheck-web:vars]
 7 ansible_ssh_user=servercheck_svc
 8 
 9 [servercheck-db]
10 db1.servercheck.in
11 
12 [servercheck-log]
13 log.servercheck.in
14 
15 [servercheck-backup]
16 backup.servercheck.in
17 
18 [servercheck-nodejs]
19 atl1.servercheck.in
20 atl2.servercheck.in
21 nyc1.servercheck.in
22 nyc2.servercheck.in
23 nyc3.servercheck.in
24 ned1.servercheck.in
25 ned2.servercheck.in
26 
27 [servercheck-nodejs:vars]
28 ansible_ssh_user=servercheck_svc
29 foo=bar
30 
31 # Server Check.in distribution-based groups.
32 [centos:children]
33 servercheck-web
34 servercheck-db
35 servercheck-nodejs
36 servercheck-backup
37 
38 [ubuntu:children]
39 servercheck-log</code></pre>
</div>
</figure>
<p>This inventory may look a little overwhelming at first, but if you break
it apart into simple groupings (web app servers, database servers,
logging server, and node.js app servers), it describes a straightforward
architecture.</p>
<figure class="image center" style="width: 85%;">
<img src="images/7-server-checkin-infrastructure.png"
style="width: 100%;" alt="Server Check.in Infrastructure." />
<figcaption aria-hidden="true">Server Check.in
Infrastructure.</figcaption>
</figure>
<p>Lines 1-29 describe a few groups of servers (some with only one server),
so playbooks and <code>ansible</code> commands can refer to the group by name.
Lines 6-7 and 27-29 set variables that will apply only to the servers in
the group (e.g. variables below <code>[servercheck-nodejs:vars]</code> will only
apply to the servers in the <code>servercheck-nodejs</code> group).</p>
<p>Lines 31-39 describe groups of groups (using <code>groupname:children</code> to
describe &lsquo;child&rsquo; groups) that allow for some helpful abstractions.</p>
<p>Describing infrastructure in such a way affords a lot of flexibility
when using Ansible. Consider the task of patching a vulnerability on all
your CentOS servers; instead of having to log into each of the servers,
or even having to run an <code>ansible</code> command against all the groups, using
the above structure allows you to easily run an ansible command or
playbook against all <code>centos</code> servers.</p>
<p>As an example, when the
<a
  href="https://en.wikipedia.org/wiki/Shellshock_%28software_bug%29"
    target="_blank"
  >Shellshock</a>
vulnerability was disclosed in 2014, patched bash packages were released
for all the major distributions within hours. To update all the Server
Check.in servers, all that was needed was:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible centos -m yum -a &quot;name=bash state=latest&quot;</code></pre>
</div>
</figure>
<p>You could even go further and create a small playbook that would patch
the vulnerability, then run tests to make sure the vulnerability was no
longer present, as illustrated in <a
  href="https://raymii.org/s/articles/Patch_CVE-2014-6271_Shellshock_with_Ansible.html"
    target="_blank"
  >this
playbook</a>.
This would also allow you to run the playbook in check mode or run it
through a continuous integration system to verify the fix works in a
non-prod environment.</p>
<p>This infrastructure inventory is also nice in that you could create a
top-level playbook that runs certain roles or tasks against all your
infrastructure, others against all servers of a certain Linux flavor,
and another against all servers in your entire infrastructure.</p>
<p>Consider, for example, this example master playbook to completely
configure all the servers:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 ---
 2 # Set up basic, standardized components across all servers.
 3 - hosts: all
 4   sudo: true
 5   roles:
 6     - security
 7     - logging
 8     - firewall
 9 
10 # Configure web application servers.
11 - hosts: servercheck-web
12   roles:
13     - nginx
14     - php
15     - servercheck-web
16 
17 # Configure database servers.
18 - hosts: servercheck-db
19   roles:
20     - pgsql
21     - db-tuning
22 
23 # Configure logging server.
24 - hosts: servercheck-log
25   roles:
26     - java
27     - elasticsearch
28     - logstash
29     - kibana
30 
31 # Configure backup server.
32 - hosts: servercheck-backup
33   roles:
34     - backup
35 
36 # Configure Node.js application servers.
37 - hosts: servercheck-nodejs
38   roles:
39     - servercheck-node</code></pre>
</div>
</figure>
<p>There are a number of different ways you can structure your
infrastructure-management playbooks and roles, and we&rsquo;ll explore some in
later chapters, but for a simple infrastructure, something like this is
adequate and maintainable.</p>

<h4 class="relative group">Non-prod environments, separate inventory files
    <div id="chap09xhtml_leanpub-auto-non-prod-environments-separate-inventory-files" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-non-prod-environments-separate-inventory-files" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Using the above playbook and the globally-configured Ansible inventory
file is great for your production infrastructure, but what happens when
you want to configure a separate but similar infrastructure for, say a
development or user certification environment?</p>
<p>In this case, it&rsquo;s easiest to use individual inventory files, rather
than the central Ansible inventory file. For typical team-managed
infrastructure, I would recommend including an inventory file for each
environment in the same version-controlled repository as your Ansible
playbooks, perhaps within an &lsquo;inventories&rsquo; directory.</p>
<p>For example, I could take the entire contents of <code>/etc/ansible/hosts</code>
above, and stash that inside an inventory file named <code>inventory-prod</code>,
then duplicate it, changing server names where appropriate (e.g. the
<code>[servercheck-web]</code> group would only have <code>www-dev1.servercheck.in</code> for
the development environment), and naming the files for the environments:</p>
<figure class="code">
<div class="highlight">
<pre><code>servercheck/
  inventories/
    inventory-prod
    inventory-cert
    inventory-dev
  playbook.yml</code></pre>
</div>
</figure>
<p>Now, when running <code>playbook.yml</code> to configure the development
infrastructure, I would pass in the path to the dev inventory (assuming
my current working directory is <code>servercheck/</code>):</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible-playbook playbook.yml -i inventories/inventory-dev</code></pre>
</div>
</figure>
<p>Using inventory variables (which will be explored further), and
well-constructed roles and/or tasks that use the variables effectively,
you could architect your entire infrastructure, with
environment-specific configurations, by changing some things in your
inventory files.</p>

<h3 class="relative group">Inventory variables
    <div id="chap09xhtml_leanpub-auto-inventory-variables" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-inventory-variables" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>Chapter 5 introduced basic methods of managing variables for individual
hosts or groups of hosts through your inventory in the <a
  href="#chap07.xhtml_inventory-variables">inventory
variables</a> section, but it&rsquo;s worth
exploring the different ways of defining and overriding variables
through inventory here.</p>
<p>For extremely simple use cases&mdash;usually when you need to define one or
two connection-related variables (like <code>ansible_ssh_user</code> or
<code>ansible_ssh_port</code>)&mdash;you can place variables directly inside an
inventory file.</p>
<p>Assuming we have a standalone inventory file for a basic web
application, here are some examples of variable definition inside the
file:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 [www]
 2 # You can define host-specific variables inline with the host.
 3 www1.example.com ansible_ssh_user=johndoe
 4 www2.example.com
 5 
 6 [db]
 7 db1.example.com
 8 db2.example.com
 9 
10 # You can add a &#39;[group:vars]&#39; heading to create variables that will apply
11 # to an entire inventory group.
12 [db:vars]
13 ansible_ssh_port=5222
14 database_performance_mode=true</code></pre>
</div>
</figure>
<p>It&rsquo;s usually better to avoid throwing too many variables inside static
inventory files, because not only are these variables typically less
visible, they are also mixed in with your architecture definition.
Especially for host-specific vars (which appear on one long line per
host), this is an unmaintainable, low-visibility approach to host and
group-specific variables.</p>
<p>Fortunately, Ansible provides a more flexible way of declaring host and
group variables.</p>

<h4 class="relative group"><code>host_vars</code>
    <div id="chap09xhtml_leanpub-auto-hostvars" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-hostvars" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>For <a
  href="https://hostedapachesolr.com/"
    target="_blank"
  >Hosted Apache Solr</a>, different
servers in a <code>solr</code> group have different memory requirements. The
simplest way to tell Ansible to override a default variable in our
Ansible playbook (in this case, the <code>tomcat_xmx</code> variable) is to use a
<code>host_vars</code> directory (which can be placed either in the same location
as your inventory file, or in a playbook&rsquo;s root directory), and place a
YAML file named after the host which needs the overridden variable.</p>
<p>As an illustration of the use of <code>host_vars</code>, we&rsquo;ll assume we have the
following directory layout:</p>
<figure class="code">
<div class="highlight">
<pre><code>hostedapachesolr/
  host_vars/
    nyc1.hostedapachesolr.com
  inventory/
    hosts
  main.yml</code></pre>
</div>
</figure>
<p>The <code>inventory/hosts</code> file contains a simple definition of all the
servers by group:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 [solr]
2 nyc1.hostedapachesolr.com
3 nyc2.hostedapachesolr.com
4 jap1.hostedapachesolr.com
5 ...
6 
7 [log]
8 log.hostedapachesolr.com</code></pre>
</div>
</figure>
<p>Ansible will search for a file at either
<code>hostedapachesolr/host_vars/nyc1.hostedapachesolr.com</code> or
<code>hostedapachesolr/inventory/host_vars/nyc1.hostedapachesolr.com</code>, and if
there are any variables defined in the file (in YAML format), those
variables will override all other playbook and role variables and
gathered facts, <em>only for the single host</em>.</p>
<p>The <code>nyc1.hostedapachesolr.com</code> host_vars file looks like:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 ---
2 tomcat_xmx: &quot;1024m&quot;</code></pre>
</div>
</figure>
<p>The default for <code>tomcat_xmx</code> may normally be <code>640m</code>, but when Ansible
runs a playbook against nyc1.hostedapachesolr.com, the value of
<code>tomcat_xmx</code> will be <code>1024m</code> instead.</p>
<p>Overriding host variables with <code>host_vars</code> is much more maintainable
than doing so directly in static inventory files, and also provides
greater visibility into what hosts are getting what overrides.</p>

<h4 class="relative group"><code>group_vars</code>
    <div id="chap09xhtml_leanpub-auto-groupvars" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-groupvars" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Much like <code>host_vars</code>, Ansible will automatically load any files named
after inventory groups in a <code>group_vars</code> directory placed inside the
playbook or inventory file&rsquo;s location.</p>
<p>Using the same example as above, we&rsquo;ll override one particular variable
for an entire group of servers. First, we add a <code>group_vars</code> directory
with a file named after the group needing the overridden variable:</p>
<figure class="code">
<div class="highlight">
<pre><code>hostedapachesolr/
  group_vars/
    solr
  host_vars/
    nyc1.hostedapachesolr.com
  inventory/
    hosts
  main.yml</code></pre>
</div>
</figure>
<p>Then, inside <code>group_vars/solr</code>, use YAML to define a list of variables
that will be applied to servers in the <code>solr</code> group:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 ---
2 do_something_amazing=true
3 foo=bar</code></pre>
</div>
</figure>
<p>Typically, if your playbook is only being run on one group of hosts,
it&rsquo;s easier to define the variables in the playbook via an included vars
file. However, in many cases you will be running a playbook or applying
a set of roles to multiple inventory groups. In these situations, you
may need to use <code>group_vars</code> to override specific variables for one or
more groups of servers.</p>

<h3 class="relative group">Ephemeral infrastructure: Dynamic inventory
    <div id="chap09xhtml_leanpub-auto-ephemeral-infrastructure-dynamic-inventory" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-ephemeral-infrastructure-dynamic-inventory" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>In many circumstances, static inventories are adequate for describing
your infrastructure. When working on small applications, low-traffic web
applications, and individual workstations, it&rsquo;s simple enough to manage
an inventory file by hand.</p>
<p>However, in the age of cloud computing and highly scalable application
architecture, it&rsquo;s often necessary to add dozens or hundreds of servers
to an infrastructure in a short period of time&mdash;or to add and remove
servers continuously, to scale as traffic grows and subsides. In this
circumstance, it would be tedious (if not impossible) to manage a single
inventory file by hand, especially if you&rsquo;re using auto-scaling
infrastructure new instances are provisioned and need to be configured
in minutes or seconds.</p>
<p>Even in the case of container-based infrastructure, new instances need
to be configured correctly, with the proper port mappings, application
settings, and filesystem configuration.</p>
<p>For these situations, Ansible allows you to define inventory
<em>dynamically</em>. If you&rsquo;re using one of the larger cloud-based hosting
providers, chances are there is already a dynamic inventory script
(which Ansible uses to build an inventory) for you to use. Ansible core
already includes scripts for Amazon Web Services, Cobbler, DigitalOcean,
Linode, OpenStack, and other large providers, and later we&rsquo;ll explore
creating our own dynamic inventory script (if you aren&rsquo;t using one of
the major hosting providers or cloud management platforms).</p>

<h4 class="relative group">Dynamic inventory with DigitalOcean
    <div id="chap09xhtml_leanpub-auto-dynamic-inventory-with-digitalocean" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-dynamic-inventory-with-digitalocean" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Digital Ocean is one of the world&rsquo;s top five hosting companies, and has
grown rapidly since it&rsquo;s founding in 2011. One of the reasons for the
extremely rapid growth is the ease of provisioning new &lsquo;droplets&rsquo; (cloud
VPS servers), and the value provided; as of this writing, you could get
a fairly speedy VPS with 512MB of RAM and a generous portion of fast SSD
storage for $5 USD per month.</p>
<p>Digital Ocean&rsquo;s API and simple developer-friendly philosophy has made it
easy for Ansible to interact with Digital Ocean droplets; you can
create, manage, and delete droplets with Ansible, as well as use
droplets with your playbooks using dynamic inventory.</p>

<h5 class="relative group">DigitalOcean account prerequisites
    <div id="chap09xhtml_leanpub-auto-digitalocean-account-prerequisites" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-digitalocean-account-prerequisites" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>Before you can follow the rest of the examples in this section, you will
need:</p>
<ol>
<li>A DigitalOcean account (sign up at <a
  href="https://www.digitalocean.com"
    target="_blank"
  >www.digitalocean.com</a>).</li>
<li><code>dopy</code>, a Python wrapper for Digital Ocean API interaction (you can
install it with pip: <code>sudo pip install dopy</code>).</li>
<li>Your DigitalOcean account API key and client ID (Ansible currently
supports the v1 API, so you need to go to the &lsquo;Apps &amp; API&rsquo; page in
your profile, then click the &lsquo;API v1.0 Page&rsquo; link to get a key and
client ID).</li>
<li>An SSH key pair, which will be used to connect to your DigitalOcean
servers. Follow <a
  href="https://www.digitalocean.com/community/tutorials/how-to-use-ssh-keys-with-digitalocean-droplets"
    target="_blank"
  >this
guide</a>
to create a key pair and add the public key to your DigitalOcean
account.</li>
</ol>
<p>Once you have these four things set up and ready to go, you should be
able to communicate with your DigitalOcean account through Ansible.</p>

<h5 class="relative group">Connecting to your DigitalOcean account
    <div id="chap09xhtml_leanpub-auto-connecting-to-your-digitalocean-account" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-connecting-to-your-digitalocean-account" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>There are a few different ways you can specify your DigitalOcean client
ID and API key (including command line arguments <code>--client-id</code> and
<code>--api-key</code>, as values inside a <code>digital_ocean.ini</code> file, or as
environment variables). For our example, we&rsquo;ll use environment variables
(since these are easy to configure, and work both with Ansible&rsquo;s
<code>digital_ocean</code> module and the dynamic inventory script). Open up a
terminal session, and enter the following commands:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ export DO_CLIENT_ID=YOUR_CLIENT_ID_HERE
$ export DO_API_KEY=YOUR_API_KEY_HERE</code></pre>
</div>
</figure>
<p>Before we can use a dynamic inventory script to discover our
DigitalOcean droplets, let&rsquo;s use Ansible to quickly provision a new
droplet.</p>
<aside class="warning blurb">
<p>Creating cloud instances (&lsquo;Droplets&rsquo;, in DigitalOcean parlance) will
incur minimal charges for the time you use them (currently less than
$0.01/hour for the size in this example). For the purposes of this
tutorial (and in general, for any testing), make sure you shut down and
destroy your instances when you&rsquo;re finished using them, or you will be
charged through the next billing cycle! Even so, using low-priced
instances (like a $5/month DigitalOcean droplet with hourly billing)
means that, even in the worst case, you won&rsquo;t have to pay much. If you
create and destroy an instance in a few hours, you&rsquo;ll be charged a few
pennies.</p>
</aside>

<h5 class="relative group">Creating a droplet with Ansible
    <div id="chap09xhtml_leanpub-auto-creating-a-droplet-with-ansible" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-creating-a-droplet-with-ansible" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>Create a new playbook named <code>provision.yml</code>, with the following
contents:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 ---
 2 - hosts: localhost
 3   connection: local
 4   gather_facts: false
 5 
 6   tasks:
 7     - name: Create new Droplet.
 8       digital_ocean:
 9         state: present
10         command: droplet
11         name: ansible-test
12         private_networking: yes
13         # 512mb
14         size_id: 66
15         # CentOS 7.0 x64
16         image_id: 6713409
17         # nyc2
18         region_id: 4
19         ssh_key_ids: 138954
20         # Required for idempotence/only one droplet creation.
21         unique_name: yes
22       register: do</code></pre>
</div>
</figure>
<p>The <code>digital_ocean</code> module lets you create, manage, and delete droplets
with ease. You can read the documentation for all the options, but the
above is an overview of the main options. <code>name</code> sets the hostname for
the droplet, <code>state</code> can also be set to <code>deleted</code> if you want the
droplet to be destroyed, and other options tell DigitalOcean where to
set up the droplet, and with what OS and configuration.</p>
<aside class="tip blurb">
<p>You can use DigitalOcean&rsquo;s API, along with your client_id and api_key,
to get the IDs for <code>size_id</code> (the size of the Droplet), <code>image_id</code> (the
system or distro image to use), <code>region_id</code> (the data center in which
your droplet will be created), and <code>ssh_key_ids</code> (a comma separate list
of SSH keys to be included in the root account&rsquo;s <code>authorized_keys</code>
file).</p>
<p>As an example, to get all the available images, use
<code>curl &quot;https://api.digitalocean.com/images/?client_id=CLIENT_ID&amp;api_key=API_KEY&amp;filter=global&quot; | python -m json.tool</code>,
substituting your own <code>CLIENT_ID</code> and <code>API_KEY</code>, and you&rsquo;ll receive a
JSON listing of all available values. Browse the <a
  href="https://developers.digitalocean.com/"
    target="_blank"
  >DigitalOcean
API</a> for information on how to
query SSH key information, size information, etc.</p>
</aside>
<p>We used <code>register</code> as part of the <code>digital_ocean</code> task so we could
immediately start using and configuring the new host if needed. Running
the above playbook returns the following output (using <code>debug: var=do</code>
in an additional task to dump the contents of our registered variable,
<code>do</code>):</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible-playbook do_test.yml
<p>PLAY [localhost] ***********************************************************</p>
<p>TASK: [Create new Droplet.] ************************************************
changed: [localhost]</p>
<p>TASK: [debug var=do] *******************************************************
ok: [localhost] =&gt; {
&quot;do&quot;: {
&quot;changed&quot;: true,
&quot;droplet&quot;: {
&quot;backups&quot;: [],
&quot;backups_active&quot;: false,
&quot;created_at&quot;: &quot;2014-10-22T02:09:20Z&quot;,
&quot;event_id&quot;: 34915980,
&quot;id&quot;: 2940194,
&quot;image_id&quot;: 6918990,
&quot;ip_address&quot;: &quot;162.243.20.29&quot;,
&quot;locked&quot;: false,
&quot;name&quot;: &quot;ansible-test&quot;,
&quot;private_ip_address&quot;: null,
&quot;region_id&quot;: 4,
&quot;size_id&quot;: 66,
&quot;snapshots&quot;: [],
&quot;status&quot;: &quot;active&quot;
},
&quot;invocation&quot;: {
&quot;module_args&quot;: &quot;&quot;,
&quot;module_name&quot;: &quot;digital_ocean&quot;
}
}
}</p>
<p>PLAY RECAP *****************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0</code></pre></p>
</div>
</figure>
<p>Since <code>do</code> contains the new droplet&rsquo;s IP address (alongside other
relevant information), you can place your freshly-created droplet in an
existing inventory group using Ansible&rsquo;s <code>add_host</code> module. Adding to
the playbook we started above, you could set up your playbook to
provision an instance and immediately configure it (after waiting for
port 22 to become available) with something like:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>24     - name: Add new host to our inventory.
25       add_host:
26         name: &quot;{{ do.droplet.ip_address }}&quot;
27         groups: do
28       when: do.droplet is defined
29 
30 - hosts: do
31   remote_user: root
32   gather_facts: false
33 
34   tasks:
35     - name: Wait for port 22 to become available.
36       local_action: &quot;wait_for port=22 host={{ inventory_hostname }}&quot;
37 
38     - name: Install tcpdump.
39       yum: name=tcpdump state=present</code></pre>
</div>
</figure>
<p>At this point, if you run the playbook
(<code>$ ansible-playbook provision.yml</code>), it should create a new droplet (if
it has not already been created), then add that droplet to the <code>do</code>
inventory group, and finally, run a new play on all the <code>do</code> hosts
(including the new droplet). Here are the results:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible-playbook provision.yml
<p>PLAY [localhost] ***********************************************************</p>
<p>TASK: [Create new Droplet.] ************************************************
changed: [localhost]</p>
<p>TASK: [Add new host to our inventory.] *************************************
ok: [localhost]</p>
<p>PLAY [do] ******************************************************************</p>
<p>TASK: [Install tcpdump.] ***************************************************
changed: [162.243.20.29]</p>
<p>PLAY RECAP *****************************************************************
162.243.20.29              : ok=2    changed=1    unreachable=0    failed=0
localhost                  : ok=2    changed=1    unreachable=0    failed=0</code></pre></p>
</div>
</figure>
<p>If you run the same playbook again, it should report no changes&mdash;the
entire playbook is idempotent! You might be starting to see just how
powerful it is to have a tool as flexible as Ansible at your disposal;
not only can you configure servers, you can create them (singly, or
dozens at a time), and configure them at once. And even if a ham-fisted
sysadmin jumps in and deletes an entire server, you can run the playbook
again, and rest assured your server will be recreated and reconfigured
exactly as it was when it was first set up.</p>
<aside class="tip blurb">
<p>Note that you might need to disable strict host key checking to get
provisioning and instant configuration to work correctly, otherwise you
may run into an error stating that Ansible can&rsquo;t connect to the new
droplet during the second play. To do this, add the line
<code>host_key_checking=False</code> under the <code>[defaults]</code> section in your
<code>ansible.cfg</code> file (located in <code>/etc/ansible</code> by default).</p>
<p>You should normally leave <code>host_key_checking</code> enabled, but when rapidly
building and destroying VMs for testing purposes, it is simplest to
disable it temporarily.</p>
</aside>

<h5 class="relative group">DigitalOcean dynamic inventory with <code>digital_ocean.py</code>
    <div id="chap09xhtml_leanpub-auto-digitalocean-dynamic-inventory-with-digitaloceanpy" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-digitalocean-dynamic-inventory-with-digitaloceanpy" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>Once you have some DigitalOcean droplets, you need a way for Ansible to
dynamically build an inventory of your servers so you can build
playbooks and use the servers in logical groupings (or run playbooks and
<code>ansible</code> commands directly on all droplets).</p>
<p>There are a few steps to getting DigitalOcean&rsquo;s official dynamic
inventory script working:</p>
<ol>
<li>Install <code>dopy</code> via pip (the DigitalOcean Python library):
<code>$ pip install dopy</code>.</li>
<li>Download the <a
  href="https://raw.githubusercontent.com/ansible/ansible/devel/plugins/inventory/digital_ocean.py"
    target="_blank"
  >DigitalOcean dynamic inventory
script</a>
from Ansible on GitHub:
<code>$ curl -O https://raw.githubusercontent.com/ansible/ansible/devel/plugins/inventory/digital_ocean.py</code>.</li>
<li>Make the inventory script executable: <code>$ chmod +x digital_ocean.py</code>.</li>
<li>Make sure you have the credentials configured in <code>digital_ocean.ini</code>
(as explained earlier in this chapter). Alternatively, you can set
<code>DO_CLIENT_ID</code> and <code>DO_API_KEY</code> in your environment, or pass the
command line options <code>--client-id</code> and <code>--api-key</code>.</li>
<li>Make sure the script is working by running the script directly:
<code>$ ./digital_ocean.py --pretty</code>. After a second or two, you should
see all your droplets (likely just the one you created earlier)
listed by IP address and dynamic group as JSON.</li>
<li>Ping all your DigitalOcean droplets:
<code>$ ansible all -m ping -i digital_ocean.py -u root</code>.</li>
</ol>
<p>Now that you have all your hosts being loaded through the dynamic
inventory script, you can use <code>add_hosts</code> to build groups of the
Droplets for use in your playbooks. Alternatively, if you want to fork
the <code>digital_ocean.py</code> inventory script, you can modify it to suit your
needs; exclude certain servers, build groups based on certain criteria,
etc.</p>
<aside class="information blurb">
<p>Ansible currently supports DigitalOcean&rsquo;s v1 API, which makes working
with DigitalOcean slightly more difficult. The v2 API allows you to use
region names (e.g. &ldquo;nyc2&rdquo;) instead of numeric IDs, allows you to <a
  href="https://www.digitalocean.com/community/tutorials/an-introduction-to-droplet-metadata"
    target="_blank"
  >add
metadata to your
droplets</a>,
and much more. Ansible should soon support the v2 API. If you&rsquo;re
interested in the current status of this effort, or would like to help
in migrating to the v2 API, visit <a
  href="https://github.com/ansible/ansible-modules-core/issues/209"
    target="_blank"
  >the v2 API support issue on
GitHub</a>.</p>
</aside>

<h4 class="relative group">Dynamic inventory with AWS
    <div id="chap09xhtml_leanpub-auto-dynamic-inventory-with-aws" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-dynamic-inventory-with-aws" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Many of this book&rsquo;s readers are familiar with Amazon Web Services
(especially EC2, S3, ElastiCache, and Route53), and likely have managed
or currently manage an infrastructure within Amazon&rsquo;s cloud. Ansible has
very strong support for managing AWS-based infrastructure, and includes
a <a
  href="https://raw.githubusercontent.com/ansible/ansible/devel/plugins/inventory/ec2.py"
    target="_blank"
  >dynamic inventory
script</a>
to help you run playbooks on your hosts in a variety of ways.</p>
<p>There are a few excellent guides to using Ansible with AWS, for example:</p>
<ul>
<li><a
  href="http://docs.ansible.com/guide_aws.html"
    target="_blank"
  >Ansible - Amazon Web Services
Guide</a></li>
<li><a
  href="https://leanpub.com/ansible-for-aws"
    target="_blank"
  >Ansible for AWS</a></li>
</ul>
<p>I won&rsquo;t be covering dynamic inventory in this chapter, but will mention
that the <code>ec2.py</code> dynamic inventory script, along with Ansible&rsquo;s
extensive support for AWS infrastructure through <code>ec2_*</code> modules, makes
Ansible the best and most simple tool for managing a broad AWS
infrastructure.</p>
<p>In the next chapter, one of the examples will include a guide for
provisioning infrastructure on AWS, along with a quick overview of
dynamic inventory on AWS.</p>

<h4 class="relative group">Inventory on-the-fly: <code>add_host</code> and <code>group_by</code>
    <div id="chap09xhtml_leanpub-auto-inventory-on-the-fly-addhost-and-groupby" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-inventory-on-the-fly-addhost-and-groupby" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Sometimes, especially when provisioning new servers, you will need to
modify the in-memory inventory during the course of a playbook run.
Ansible offers the <code>add_host</code> and <code>group_by</code> modules to help you manage
inventory for these scenarios.</p>
<p>In the DigitalOcean example above, <code>add_host</code> was used to add the new
droplet to the <code>do</code> group:</p>
<figure class="code">
<div class="highlight">
<pre><code>[...]
    - name: Add new host to our inventory.
      add_host:
        name: &quot;{{ do.droplet.ip_address }}&quot;
        groups: do
      when: do.droplet is defined
<ul>
<li>
<p>hosts: do
remote_user: root</p>
<p>tasks:
[&hellip;]</code></pre></p>
</li>
</ul>
</div>
</figure>
<p>You could add multiple groups with add_host, and you can also add other
variables for the host inline with <code>add_host</code>. As an example, let&rsquo;s say
you created a VM using an image that exposes SSH on port 2288 and
requires an application-specific memory limit specific to this VM:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Add new host to our inventory.
  add_host:
    name: &quot;{{ do.droplet.ip_address }}&quot;
    ansible_ssh_port: 2288
    myapp_memory_maximum: &quot;1G&quot;
  when: do.droplet is defined</code></pre>
</div>
</figure>
<p>The custom port will be used when Ansible connects to this host, and the
<code>myapp_memory_maximum</code> will be passed into the playbooks just as any
other inventory variable.</p>
<p>The <code>group_by</code> module is even simpler, and allows you to create dynamic
groups during the course of a playbook run. Usage is extremely simple:</p>
<figure class="code">
<div class="highlight">
<pre><code>- hosts: all
  gather_facts: yes
  tasks:
    - name: Create an inventory group for each architecture.
      group_by: &quot;key=architecture-{{ ansible_machine }}&quot;
<pre><code>- debug: var=groups&lt;/code&gt;&lt;/pre&gt;
</code></pre>
</div>
</figure>
<p>After running the above playbook, you&rsquo;d see all your normal inventory
groups, plus groups for <code>architecture-x86_64</code>, <code>i386</code>, etc. (depending
on what kind of server architectures you use).</p>

<h4 class="relative group">Multiple inventory sources - mixing static and dynamic inventories
    <div id="chap09xhtml_leanpub-auto-multiple-inventory-sources---mixing-static-and-dynamic-inventories" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-multiple-inventory-sources---mixing-static-and-dynamic-inventories" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>If you need to combine static and dynamic inventory, or even if you wish
to use multiple dynamic inventories (for example, if you are managing
servers hosted by two different cloud providers), you can pass a
directory to <code>ansible</code> or <code>ansible-playbook</code>, and Ansible will combine
the output of all the inventories (both static and dynamic) inside the
directory:</p>
<figure class="code">
<div class="highlight">
<pre><code>`ansible-playbook -i path/to/inventories main.yml`</code></pre>
</div>
</figure>
<p>One caveat: Ansible ignores <code>.ini</code> and backup files in the directory,
but will attempt to parse every text file and execute every executable
file in the directory&mdash;don&rsquo;t leave random files in mixed inventory
folders!</p>

<h4 class="relative group">Creating custom dynamic inventories
    <div id="chap09xhtml_leanpub-auto-creating-custom-dynamic-inventories" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-creating-custom-dynamic-inventories" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Most infrastructure can be managed with a custom inventory file or an
off-the-shelf cloud inventory script, but there are many situations
where more control is needed. Ansible will accept any kind of executable
file as an inventory file, so you can build your own dynamic inventory
however you like, as long as you can pass it to Ansible as JSON.</p>
<p>You could create an executable binary, a script, or anything else that
can be run and will output JSON to stdout, and Ansible will call it with
the argument <code>--list</code> when you run, as an example,
<code>ansible all -i my-inventory-script -m ping</code>.</p>
<p>Let&rsquo;s start working our own custom dynamic inventory script by outlining
the basic JSON format Ansible expects:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 {
 2     &quot;group&quot;: {
 3         &quot;hosts&quot;: [
 4             &quot;192.168.28.71&quot;,
 5             &quot;192.168.28.72&quot;
 6         ],
 7         &quot;vars&quot;: {
 8             &quot;ansible_ssh_user&quot;: &quot;johndoe&quot;,
 9             &quot;ansible_ssh_private_key_file&quot;: &quot;~/.ssh/mykey&quot;,
10             &quot;example_variable&quot;: &quot;value&quot;
11         }
12     },
13     &quot;_meta&quot;: {
14         &quot;hostvars&quot;: {
15             &quot;192.168.28.71&quot;: {
16                 &quot;host_specific_var&quot;: &quot;bar&quot;
17             },
18             &quot;192.168.28.72&quot;: {
19                 &quot;host_specific_var&quot;: &quot;foo&quot;
20             }
21         }
22     }
23 }</code></pre>
</div>
</figure>
<p>Ansible expects a dictionary of groups (with each group having a list of
<code>hosts</code>, and group variables in the group&rsquo;s <code>vars</code> dictionary), and a
<code>_meta</code> dictionary that stores host variables for all hosts individually
inside a <code>hostvars</code> dictionary.</p>
<aside class="tip blurb">
<p>When you return a <code>_meta</code> dictionary in your inventory script, Ansible
stores that data in its cache and doesn&rsquo;t call your inventory script <em>N</em>
times for all the hosts in the inventory. You can leave out the <code>_meta</code>
variables if you&rsquo;d rather structure your inventory file to return host
variables one host at a time (Ansible will call your script with the
arguments <code>--host [hostname]</code> for each host), but it&rsquo;s often faster and
easier to simply return all variables in the first call. In this book,
all the examples will use the <code>_meta</code> dictionary.</p>
</aside>
<p>The dynamic inventory script can do anything to get the data (call an
external API, pull information from a database or file, etc.), and
Ansible will use it as an inventory source, so long as it returns a JSON
structure like the one above when the script is called with the
<code>--list</code>.</p>

<h5 class="relative group">Building a Custom Dynamic Inventory in Python
    <div id="chap09xhtml_leanpub-auto-building-a-custom-dynamic-inventory-in-python" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-building-a-custom-dynamic-inventory-in-python" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>To create a test dynamic inventory script for demonstration purposes,
let&rsquo;s set up a quick set of two VMs using Vagrant. Create the following
<code>Vagrantfile</code> in a new directory:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 VAGRANTFILE_API_VERSION = &quot;2&quot;
 2 
 3 Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
 4   config.ssh.insert_key = false
 5   config.vm.provider :virtualbox do |vb|
 6     vb.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, &quot;256&quot;]
 7   end
 8 
 9   # Application server 1.
10   config.vm.define &quot;inventory1&quot; do |inventory|
11     inventory.vm.hostname = &quot;inventory1.dev&quot;
12     inventory.vm.box = &quot;geerlingguy/ubuntu1404&quot;
13     inventory.vm.network :private_network, ip: &quot;192.168.28.71&quot;
14   end
15 
16   # Application server 2.
17   config.vm.define &quot;inventory2&quot; do |inventory|
18     inventory.vm.hostname = &quot;inventory2.dev&quot;
19     inventory.vm.box = &quot;geerlingguy/ubuntu1404&quot;
20     inventory.vm.network :private_network, ip: &quot;192.168.28.72&quot;
21   end
22 end</code></pre>
</div>
</figure>
<p>Run <code>vagrant up</code> to boot two VMs running Ubuntu 14.04, with the IP
addresses <code>192.168.28.71</code>, and <code>192.168.28.72</code>. A simple inventory file
could be used to control the VMs with Ansible:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 [group]
2 192.168.28.71 host_specific_var=foo
3 192.168.28.72 host_specific_var=bar
4 
5 [group:vars]
6 ansible_ssh_user=vagrant
7 ansible_ssh_private_key_file=~/.vagrant.d/insecure_private_key
8 example_variable=value</code></pre>
</div>
</figure>
<p>However, let&rsquo;s assume the VMs were provisioned by another system, and
you need to get the information through a dynamic inventory script.
Here&rsquo;s a simple implementation of a dynamic inventory script in Python:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 #!/usr/bin/env python
 2 
 3 &#39;&#39;&#39;
 4 Example custom dynamic inventory script for Ansible, in Python.
 5 &#39;&#39;&#39;
 6 
 7 import os
 8 import sys
 9 import argparse
10 
11 try:
12     import json
13 except ImportError:
14     import simplejson as json
15 
16 class ExampleInventory(object):
17 
18     def __init__(self):
19         self.inventory = {}
20         self.read_cli_args()
21 
22         # Called with `--list`.
23         if self.args.list:
24             self.inventory = self.example_inventory()
25         # Called with `--host [hostname]`.
26         elif self.args.host:
27             # Not implemented, since we return _meta info `--list`.
28             self.inventory = self.empty_inventory()
29         # If no groups or vars are present, return an empty inventory.
30         else:
31             self.inventory = self.empty_inventory()
32 
33         print json.dumps(self.inventory);
34 
35     # Example inventory for testing.
36     def example_inventory(self):
37         return {
38             &#39;group&#39;: {
39                 &#39;hosts&#39;: [&#39;192.168.28.71&#39;, &#39;192.168.28.72&#39;],
40                 &#39;vars&#39;: {
41                     &#39;ansible_ssh_user&#39;: &#39;vagrant&#39;,
42                     &#39;ansible_ssh_private_key_file&#39;:
43                         &#39;~/.vagrant.d/insecure_private_key&#39;,
44                     &#39;example_variable&#39;: &#39;value&#39;
45                 }
46             },
47             &#39;_meta&#39;: {
48                 &#39;hostvars&#39;: {
49                     &#39;192.168.28.71&#39;: {
50                         &#39;host_specific_var&#39;: &#39;foo&#39;
51                     },
52                     &#39;192.168.28.72&#39;: {
53                         &#39;host_specific_var&#39;: &#39;bar&#39;
54                     }
55                 }
56             }
57         }
58 
59     # Empty inventory for testing.
60     def empty_inventory(self):
61         return {&#39;_meta&#39;: {&#39;hostvars&#39;: {}}}
62 
63     # Read the command line args passed to the script.
64     def read_cli_args(self):
65         parser = argparse.ArgumentParser()
66         parser.add_argument(&#39;--list&#39;, action = &#39;store_true&#39;)
67         parser.add_argument(&#39;--host&#39;, action = &#39;store&#39;)
68         self.args = parser.parse_args()
69 
70 # Get the inventory.
71 ExampleInventory()</code></pre>
</div>
</figure>
<p>Save the above as <code>inventory.py</code> in the same folder as the <code>Vagrantfile</code>
you created earlier (make sure you booted the two VMs with
<code>vagrant up</code>), and make the file executable <code>chmod +x inventory.py</code>.</p>
<p>Run the inventory script manually to verify it returns the proper JSON
response when run with <code>--list</code>:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ./inventory.py --list
{&quot;group&quot;: {&quot;hosts&quot;: [&quot;192.168.28.71&quot;, &quot;192.168.28.72&quot;], &quot;vars&quot;:
{&quot;ansible_ssh_user&quot;: &quot;vagrant&quot;, &quot;ansible_ssh_private_key_file&quot;:
&quot;~/.vagrant.d/insecure_private_key&quot;, &quot;example_variable&quot;: &quot;value
&quot;}}, &quot;_meta&quot;: {&quot;hostvars&quot;: {&quot;192.168.28.72&quot;: {&quot;host_specific_va
r&quot;: &quot;bar&quot;}, &quot;192.168.28.71&quot;: {&quot;host_specific_var&quot;: &quot;foo&quot;}}}}</code></pre>
</div>
</figure>
<p>Test Ansible&rsquo;s ability to use the inventory script to contact the two
VMs:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible all -i inventory.py -m ping
192.168.28.71 | success &gt;&gt; {
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
}
<p>192.168.28.72 | success &gt;&gt; {
&quot;changed&quot;: false,
&quot;ping&quot;: &quot;pong&quot;
}</code></pre></p>
</div>
</figure>
<p>Since Ansible can connect, verify the configured host variables (<code>foo</code>
and <code>bar</code>) are set correctly on their respective hosts:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible all -i inventory.py -m debug -a &quot;var=host_specific_var&quot;
192.168.28.71 | success &gt;&gt; {
    &quot;var&quot;: {
        &quot;host_specific_var&quot;: &quot;foo&quot;
    }
}
<p>192.168.28.72 | success &gt;&gt; {
&quot;var&quot;: {
&quot;host_specific_var&quot;: &quot;bar&quot;
}
}</code></pre></p>
</div>
</figure>
<p>The only alteration for real-world usage you&rsquo;d need to make to the above
<code>inventory.py</code> script would be changing the <code>example_inventory()</code> method
to something that incorporates the business logic you would need for
your own inventory, whether it would be calling an external API with all
the server data or pulling in the information from a database or other
data store.</p>

<h5 class="relative group">Building a Custom Dynamic Inventory in PHP
    <div id="chap09xhtml_leanpub-auto-building-a-custom-dynamic-inventory-in-php" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-building-a-custom-dynamic-inventory-in-php" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p>You can build an inventory script in whatever language you&rsquo;d like. For
example, the Python script from above can be ported to functional PHP as
follows:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 #!/usr/bin/php
 2 &lt;?php
 3 
 4 /**
 5  * @file
 6  * Example custom dynamic inventory script for Ansible, in PHP.
 7  */
 8 
 9 /**
10  * Example inventory for testing.
11  *
12  * @return array
13  *   An example inventory with two hosts.
14  */
15 function example_inventory() {
16   return [
17     &#39;group&#39; =&gt; [
18       &#39;hosts&#39; =&gt; [&#39;192.168.28.71&#39;, &#39;192.168.28.72&#39;],
19       &#39;vars&#39; =&gt; [
20         &#39;ansible_ssh_user&#39; =&gt; &#39;vagrant&#39;,
21         &#39;ansible_ssh_private_key_file&#39; =&gt; &#39;~/.vagrant.d/insecure_private_key&#39;,
22         &#39;example_variable&#39; =&gt; &#39;value&#39;,
23       ],
24     ],
25     &#39;_meta&#39; =&gt; [
26       &#39;hostvars&#39; =&gt; [
27         &#39;192.168.28.71&#39; =&gt; [
28           &#39;host_specific_var&#39; =&gt; &#39;foo&#39;,
29         ],
30         &#39;192.168.28.72&#39; =&gt; [
31           &#39;host_specific_var&#39; =&gt; &#39;bar&#39;,
32         ],
33       ],
34     ],
35   ];
36 }
37 
38 /**
39  * Empty inventory for testing.
40  *
41  * @return array
42  *   An empty inventory.
43  */
44 function empty_inventory() {
45   return [&#39;_meta&#39; =&gt; [&#39;hostvars&#39; =&gt; new stdClass()]];
46 }
47 
48 /**
49  * Get inventory.
50  *
51  * @param array $argv
52  *   Array of command line arguments (as returned by $_SERVER[&#39;argv&#39;]).
53  *
54  * @return array
55  *   Inventory of groups or vars, depending on arguments.
56  */
57 function get_inventory($argv = []) {
58   $inventory = new stdClass();
59 
60   // Called with `--list`.
61   if (!empty($argv[1]) &amp;&amp; $argv[1] == &#39;--list&#39;) {
62     $inventory = example_inventory();
63   }
64   // Called with `--host [hostname]`.
65   elseif ((!empty($argv[1]) &amp;&amp; $argv[1] == &#39;--host&#39;) &amp;&amp; !empty($argv[2])) {
66     // Not implemented, since we return _meta info `--list`.
67     $inventory = empty_inventory();
68   }
69   // If no groups or vars are present, return an empty inventory.
70   else {
71     $inventory = empty_inventory();
72   }
73 
74   print json_encode($inventory);
75 }
76 
77 // Get the inventory.
78 get_inventory($_SERVER[&#39;argv&#39;]);
79 
80 ?&gt;</code></pre>
</div>
</figure>
<p>If you were to save the code above into the file <code>inventory.php</code>, mark
it executable (<code>chmod +x inventory.php</code>), and run the same Ansible
command as earlier (referencing <code>inventory.php</code> instead of
<code>inventory.py</code>), the command should succeed, just as with the previous
Python example.</p>
<aside class="information blurb">
<p>All the files mentioned in these dynamic inventory examples are
available in the <a
  href="https://github.com/geerlingguy/ansible-for-devops"
    target="_blank"
  >Ansible for DevOps GitHub
repository</a>, in the
<code>dynamic-inventory</code> folder.</p>
</aside>

<h5 class="relative group">Managing a PaaS with a Custom Dynamic Inventory
    <div id="chap09xhtml_leanpub-auto-managing-a-paas-with-a-custom-dynamic-inventory" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-managing-a-paas-with-a-custom-dynamic-inventory" aria-label="Anchor">#</a>
    </span>
    
</h5>
<p><a
  href="https://hostedapachesolr.com/"
    target="_blank"
  >Hosted Apache Solr</a>&rsquo;s infrastructure is
built using a custom dynamic inventory to allow for centrally-controlled
server provisioning and configuration. Here&rsquo;s how the server
provisioning process works on Hosted Apache Solr:</p>
<ol>
<li>A Drupal website holds a &lsquo;Server&rsquo; content type that stores metadata
about each server (e.g. chosen hostname, data center location,
choice of OS image, and memory settings).</li>
<li>When a new server is added, a remote Jenkins job is triggered,
which: 1. Builds a new cloud server on DigitalOcean using an Ansible
playbook. 2. Runs a provisioning playbook on the server to
initialize the configuration. 3. Adds a new DNS entry for the
server. 4. Posts additional server metadata (like the IP address)
back to the Drupal website via a private API.</li>
<li>When a server is updated, or there is new configuration to be
deployed to the server(s), a different Jenkins job is triggered,
which: 1. Runs the same provisioning playbook on all the
DigitalOcean servers. This playbook uses an inventory script which
calls back to an inventory API endpoint that returns all the server
information as JSON (the inventory script on the Jenkins server
passes the JSON through to stdout). 2. Reports back success or
failure of the ansible playbook to the REST API.</li>
</ol>
<p>The above process transformed the management of the entire Hosted Apache
Solr platform. Instead of taking twenty to thirty minutes to build a new
server (even when using an Ansible playbook with a few manual steps),
the process can be completed in just a few minutes, with no manual
intervention.</p>
<aside class="warning blurb">
<p>The security of your server inventory and infrastructure management
should be a top priority; Hosted Apache Solr uses HTTPS everywhere, and
has a hardened private API for inventory access and server metadata. If
you have any automated processes that run over a network, you should
take extra care to audit these processes and all the involved systems
thoroughly!</p>
</aside>

<h3 class="relative group">Summary
    <div id="chap09xhtml_leanpub-auto-summary-6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap09xhtml_leanpub-auto-summary-6" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>From the most basic infrastructure consisting of one server to a
multi-tenant, dynamic infrastructure with thousands of them, Ansible
offers many options for describing your servers and overriding playbook
and role variables for specific hosts or groups. With Ansible&rsquo;s flexible
inventory system, you should be able to describe all your servers,
however they&rsquo;re managed and wherever they&rsquo;re hosted.</p>
<figure class="code">
<div class="highlight">
<pre><code> ___________________________________
/ A pint of sweat saves a gallon of \
\ blood. (General Patton)           /
 -----------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||</code></pre>
</div>
</figure>
:::
<p>[]{#chap10.xhtml}</p>
<p>::: {}</p>

          
          
          
        </div>
        
        

        

        

      </div>

      
      
        
        
          
          
        
        
        
        <script
          type="text/javascript"
          src="/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js"
          integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="
          data-oid="views_tech notes/RHCE/Ansible4Devops/Chapter 7 - Inventories.md"
          data-oid-likes="likes_tech notes/RHCE/Ansible4Devops/Chapter 7 - Inventories.md"></script>
      
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      

      
    </footer>
  </article>

        


  






<div
  id="scroll-to-top"
  class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200">
  <a
    href="#the-top"
    class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top"
    title="Scroll to top">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
      
      
        
      
      
      
      
      <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 overflow-x-auto py-2">
        <ul class="flex list-none flex-row">
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 me-4">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href=""
                title="">
                
                
              </a>
            </li>
          
        </ul>
      </nav>
    
  
  <div class="flex items-center justify-between">
    
    
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          &copy;
          2025
          David Thomas
      </p>
    

    
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
  <script
    type="text/javascript"
    src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js"
    integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="http://localhost:1313/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
