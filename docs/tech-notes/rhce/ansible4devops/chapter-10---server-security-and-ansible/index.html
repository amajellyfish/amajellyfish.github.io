<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="false"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="en">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  
    <title> &middot; David Thomas</title>
    <meta name="title" content=" &middot; David Thomas">
  

  
  
  
  
  
  <link rel="canonical" href="http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-10---server-security-and-ansible/">
  

  
  
    <meta name="author" content="David Thomas">
  
  

  
  <meta property="og:url" content="http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-10---server-security-and-ansible/">
  <meta property="og:site_name" content="David Thomas">
  <meta property="og:title" content="David Thomas">
  <meta property="og:description" content="Chapter 10 - Server Security and Ansible # The first configuration to be performed on any new server—especially any server with any exposure (direct or indirect) to the public Internet)—is security configuration.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="tech-notes">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="David Thomas">
  <meta name="twitter:description" content="Chapter 10 - Server Security and Ansible # The first configuration to be performed on any new server—especially any server with any exposure (direct or indirect) to the public Internet)—is security configuration.">

  
  
  
  
    
      
    
  
    
      
    
  
    
      
    
  
  
    
  

  
  
  
  
  
  

  

  
  
  
  
  
  
  
    
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.c5c4ab59b36e3a06d6dff38478af5d2c18b2d7a3603611d7fc5647b02111f989bd5957610b6bed4d10718428186bc7c38590e84c77c0d50f401da78f4fbb5384.css"
    integrity="sha512-xcSrWbNuOgbW3/OEeK9dLBiy16NgNhHX/FZHsCER&#43;Ym9WVdhC2vtTRBxhCgYa8fDhZDoTHfA1Q9AHaePT7tThA==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js"
    integrity="sha512-b0EXSzoFtoCCD&#43;CMrb&#43;l&#43;3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script>
  
  
  
  
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
  
    
  
  
    
  
  
    
  
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js"
      integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP&#43;pSqMXxm6JPOUeAg=="
      data-copy="Copy"
      data-copied="Copied"></script>
  

  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>


























  

  

  

  

  





  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "",
    "headline": "",
    
    "abstract": "\u003ch2 class=\u0022relative group\u0022\u003eChapter 10 - Server Security and Ansible\n    \u003cdiv id=\u0022chapter-10---server-security-and-ansible\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#chapter-10---server-security-and-ansible\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cp\u003eThe first configuration to be performed on any new server\u0026mdash;especially\nany server with any exposure (direct or indirect) to the public\nInternet)\u0026mdash;is security configuration.\u003c\/p\u003e",
    "inLanguage": "en",
    "url" : "http://localhost:1313/tech-notes/rhce/ansible4devops/chapter-10---server-security-and-ansible/",
    "author" : {
      "@type": "Person",
      "name": "David Thomas"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "6046"
  }]
  </script>



  
  

  
  

  
  

  
  
    
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
      <script>

    const firebaseConfig = {
      apiKey: "AIzaSyApsKLCbGb5fkkrzxABOtl3-OUuBcRPVsc",
      authDomain: "davidwrites-89dd7.firebaseapp.com",
      projectId: "davidwrites-89dd7",
      storageBucket: "davidwrites-89dd7.firebasestorage.app",
      messagingSenderId: "433139099634",
      appId: "1:433139099634:web:c14275555bd7171e6c6d6b",
      measurementId: "G-XX5507B82W"
    };

        var app = firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var auth = firebase.auth();

      </script>
    
  

  
  
</head>







  
    
  







  
    
  






  
  
  <body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        Skip to main content
      </a>
    </div>
    
    
      













<div
  class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0">
  
  
    
    

  <div class="flex flex-1 items-center justify-between">
    <nav class="flex space-x-3">
      
        <a href="/" class="text-base font-medium">
          David Thomas
        </a>
      
    </nav>
    
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">
    
      
        
  <a
  href="/tech-notes/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Tech Notes"
  title="">
  
  
    <p class="text-base font-medium">
      Tech Notes
    </p>
  
</a>



      
        
  <a
  href="/notes/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Notes"
  title="Book Notes &amp; Reviews">
  
  
    <p class="text-base font-medium">
      Notes
    </p>
  
</a>



      
        
  <a
  href="/articles/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Articles"
  title="Articles">
  
  
    <p class="text-base font-medium">
      Articles
    </p>
  
</a>



      
        
  <a
  href="/now/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Now"
  title="Now">
  
  
    <p class="text-base font-medium">
      Now
    </p>
  
</a>



      
        
  <a
  href=""
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  
  title="">
  
  
</a>



      
    

    

    

    
      <button
        id="search-button"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </nav>

    
  <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">
    <span></span>

    

    

    
      <button
        id="search-button-mobile"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </div>

  </div>
  
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]">
          <ul
            class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
              </span>
            </li>

            
              
  <li class="mt-1">
  <a
    href="/tech-notes/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Tech Notes"
    title="">
    
    
      <p class="text-bg font-bg">
        Tech Notes
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/notes/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Notes"
    title="Book Notes &amp; Reviews">
    
    
      <p class="text-bg font-bg">
        Notes
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/articles/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Articles"
    title="Articles">
    
    
      <p class="text-bg font-bg">
        Articles
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/now/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Now"
    title="Now">
    
    
      <p class="text-bg font-bg">
        Now
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href=""
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    
    title="">
    
    
  </a>
</li>



            

          </ul>
          
        </div>
      
    </div>
  </div>

</div>




  <script>
    (function () {
      var $mainmenu = $(".main-menu");
      var path = window.location.pathname;
      $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
        $(e).children("p").addClass("active");
      });
    })();
  </script>


    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  
    
  

  

  
    
  

  

  

  

  
    
  

  
    
  

  
    
  

  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="0001-01-01T00:00:00&#43;00:00">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span
    id="views_tech notes/RHCE/Ansible4Devops/Chapter 10 - Server Security and Ansible.md"
    class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400"
    title="views"
    >loading</span
  >
  <span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
<path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span>
<span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span
    id="likes_tech notes/RHCE/Ansible4Devops/Chapter 10 - Server Security and Ansible.md"
    class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400"
    title="likes"
    >loading</span
  >
  <span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span>
</span>
<span class="px-2 text-primary-500">&middot;</span><span>
  <button
    id="button_likes"
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    <span id="button_likes_heart" class="inline-block align-text-bottom hidden"
      ><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span>
    </span>
    <span id="button_likes_emtpty_heart" class="inline-block align-text-bottom"
      ><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M244 84L255.1 96L267.1 84.02C300.6 51.37 347 36.51 392.6 44.1C461.5 55.58 512 115.2 512 185.1V190.9C512 232.4 494.8 272.1 464.4 300.4L283.7 469.1C276.2 476.1 266.3 480 256 480C245.7 480 235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1 0 232.4 0 190.9V185.1C0 115.2 50.52 55.58 119.4 44.1C164.1 36.51 211.4 51.37 244 84C243.1 84 244 84.01 244 84L244 84zM255.1 163.9L210.1 117.1C188.4 96.28 157.6 86.4 127.3 91.44C81.55 99.07 48 138.7 48 185.1V190.9C48 219.1 59.71 246.1 80.34 265.3L256 429.3L431.7 265.3C452.3 246.1 464 219.1 464 190.9V185.1C464 138.7 430.4 99.07 384.7 91.44C354.4 86.4 323.6 96.28 301.9 117.1L255.1 163.9z"/></svg></span></span
    >
    <span id="button_likes_text">&nbsp;Like</span>
  </button>
</span>
    

    
    
  </div>

  

  
  

  
  



      </div>
      
        
  
  
  
  
  
  

  

  

  

  

      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky lg:top-10">
            
              <details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#chapter-10---server-security-and-ansible">Chapter 10 - Server Security and Ansible</a>
      <ul>
        <li><a href="#chap12.xhtml_leanpub-auto-a-brief-history-of-ssh-and-remote-access">A brief history of SSH and remote access</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-telnet">Telnet</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-rlogin-rsh-and-rcp">rlogin, rsh and rcp</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-ssh">SSH</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-the-evolution-of-ssh-and-the-future-of-remote-access">The evolution of SSH and the future of remote access</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-secure-and-encrypted-communication">Use secure and encrypted communication</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-disable-root-login-and-use-sudo">Disable root login and use <code>sudo</code></a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-remove-unused-software-open-only-required-ports">Remove unused software, open only required ports</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-the-principle-of-least-privilege">Use the principle of least privilege</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-user-account-configuration">User account configuration</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-file-permissions">File permissions</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-update-the-os-and-installed-software">Update the OS and installed software</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates">Automating updates</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates-for-redhat-based-systems">Automating updates for RedHat-based systems</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates-for-debian-based-systems">Automating updates for Debian-based systems</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-a-properly-configured-firewall">Use a properly-configured firewall</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-configuring-a-firewall-with-ufw-on-debian-or-ubuntu">Configuring a firewall with <code>ufw</code> on Debian or Ubuntu</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-configuring-a-firewall-with-firewalld-on-redhat-fedora-or-centos">Configuring a firewall with <code>firewalld</code> on RedHat, Fedora, or CentOS</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-make-sure-log-files-are-populated-and-rotated">Make sure log files are populated and rotated</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-monitor-logins-and-block-suspect-ip-addresses">Monitor logins and block suspect IP addresses</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-selinux-security-enhanced-linux-or-apparmor">Use SELinux (Security-Enhanced Linux) or AppArmor</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-summary-and-further-reading">Summary and further reading</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#chapter-10---server-security-and-ansible">Chapter 10 - Server Security and Ansible</a>
      <ul>
        <li><a href="#chap12.xhtml_leanpub-auto-a-brief-history-of-ssh-and-remote-access">A brief history of SSH and remote access</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-telnet">Telnet</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-rlogin-rsh-and-rcp">rlogin, rsh and rcp</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-ssh">SSH</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-the-evolution-of-ssh-and-the-future-of-remote-access">The evolution of SSH and the future of remote access</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-secure-and-encrypted-communication">Use secure and encrypted communication</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-disable-root-login-and-use-sudo">Disable root login and use <code>sudo</code></a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-remove-unused-software-open-only-required-ports">Remove unused software, open only required ports</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-the-principle-of-least-privilege">Use the principle of least privilege</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-user-account-configuration">User account configuration</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-file-permissions">File permissions</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-update-the-os-and-installed-software">Update the OS and installed software</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates">Automating updates</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates-for-redhat-based-systems">Automating updates for RedHat-based systems</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-automating-updates-for-debian-based-systems">Automating updates for Debian-based systems</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-a-properly-configured-firewall">Use a properly-configured firewall</a>
          <ul>
            <li><a href="#chap12.xhtml_leanpub-auto-configuring-a-firewall-with-ufw-on-debian-or-ubuntu">Configuring a firewall with <code>ufw</code> on Debian or Ubuntu</a></li>
            <li><a href="#chap12.xhtml_leanpub-auto-configuring-a-firewall-with-firewalld-on-redhat-fedora-or-centos">Configuring a firewall with <code>firewalld</code> on RedHat, Fedora, or CentOS</a></li>
          </ul>
        </li>
        <li><a href="#chap12.xhtml_leanpub-auto-make-sure-log-files-are-populated-and-rotated">Make sure log files are populated and rotated</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-monitor-logins-and-block-suspect-ip-addresses">Monitor logins and block suspect IP addresses</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-use-selinux-security-enhanced-linux-or-apparmor">Use SELinux (Security-Enhanced Linux) or AppArmor</a></li>
        <li><a href="#chap12.xhtml_leanpub-auto-summary-and-further-reading">Summary and further reading</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>


<script>
  (function () {
    'use strict'

    const SCROLL_OFFSET_RATIO = 0.33
    const TOC_SELECTOR = '#TableOfContents'
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false

    function getActiveAnchorId(anchors, offsetRatio) {
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...document.querySelectorAll('#TableOfContents a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => link.getAttribute('href').substring(1)))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      for (let i = anchors.length - 1; i >= 0; i--) {
        const top = anchors[i].getBoundingClientRect().top + window.scrollY
        if (top <= threshold && tocIds.has(anchors[i].id)) {
          return anchors[i].id
        }
      }
      return anchors.find(anchor => tocIds.has(anchor.id))?.id || ''
    }

    function updateTOC({ toc, anchors, links, scrollOffset, collapseInactive }) {
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) return

      links.forEach(link => {
        const isActive = link.getAttribute('href') === `#${activeId}`
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        let el = activeLink
        while (el && el !== toc) {
          if (el.tagName === 'UL') el.style.display = ''
          if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
          el = el.parentElement
        }
      }
    }

    function initTOC() {
      const toc = document.querySelector(TOC_SELECTOR)
      if (!toc) return

      const collapseInactive = true
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
        })
      })

      const config = {
        toc,
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      window.addEventListener('scroll', () => updateTOC(config), { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      updateTOC(config)
    }

    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', initTOC)
      : initTOC()
  })()
</script>


            
          </div>
        </div>
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          
<h2 class="relative group">Chapter 10 - Server Security and Ansible
    <div id="chapter-10---server-security-and-ansible" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chapter-10---server-security-and-ansible" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>The first configuration to be performed on any new server&mdash;especially
any server with any exposure (direct or indirect) to the public
Internet)&mdash;is security configuration.</p>
<p>There are nine basic measures to ensure servers are secure from
unauthorized access or intercepted communications:</p>
<ol>
<li>Use secure and encrypted communication.</li>
<li>Disable root login and use <code>sudo</code>.</li>
<li>Remove unused software, open only required ports.</li>
<li>Use the principle of least privilege.</li>
<li>Update the OS and installed software.</li>
<li>Use a properly-configured firewall.</li>
<li>Make sure log files are populated and rotated.</li>
<li>Monitor logins and block suspect IP addresses.</li>
<li>Use SELinux (Security-Enhanced Linux).</li>
</ol>
<p>Your infrastructure is as weak as the weakest server; in many
high-profile security breaches, one poorly-secured server acts as a
gateway into the rest of the network. Don&rsquo;t let your servers be <em>those</em>
servers! Good security also helps you achieve the holy grail of system
administration&mdash;100% uptime.</p>
<p>In this chapter, you&rsquo;ll learn about Linux security and how Ansible helps
secure your servers, following the basic topics above.</p>

<h3 class="relative group">A brief history of SSH and remote access
    <div id="chap12xhtml_leanpub-auto-a-brief-history-of-ssh-and-remote-access" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-a-brief-history-of-ssh-and-remote-access" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>In the beginning, computers were the size of large conference rooms. A
punch card reader would merrily accept pieces of paper with instructions
the computer would run, and then a printer would etch the results into
another piece of paper. Thousands of mechanical parts worked
harmoniously (when they <em>did</em> work) to compute relatively simple
commands.</p>
<p>As time progressed, computers became somewhat smaller, and interactive
terminals became more user-friendly, but they were still wired directly
into the computer being used. Mainframes came to the fore in the 1960s,
originally used via typewriter and teletype interfaces, then via
keyboards and small text displays. As networked computing became more
mainstream in the 1970s and 1980s, remote terminal access was used to
interact with the large central computers.</p>
<p>The first remote terminal interfaces assumed a high level of trust
between the central computer and all those on the network, because the
small, centralized networks used were physically isolated from one
another.</p>

<h4 class="relative group">Telnet
    <div id="chap12xhtml_leanpub-auto-telnet" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-telnet" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>In the late 1960s, the Telnet protocol was defined and started being
used over TCP networks (normally on port 23) for remote control over
larger private networks, and eventually the public Internet.</p>
<p>Telnet&rsquo;s underlying technology (a text-based protocol to transfer data
between different systems) was the basis for many foundational
communications protocols in use today, including HTTP, FTP, and POP3.
However, plain text streams are not secure, and even with the addition
of TLS and SASL, Telnet was never very secure by default. With the
advent of SSH (which we&rsquo;ll get to in a bit), the protocol has declined
in popularity for most remote administration purposes.</p>
<p>Telnet still has uses like configuring devices over local serial
connections, or checking if a particular service is operating correctly
on a remote server (like an HTTP server on port 80, mysql on port 3306,
or munin on port 4949), but it is not installed by default on modern
Linux distributions.</p>
<aside class="warning blurb">
<p>Plain text communications over a network are only as secure as the
network&rsquo;s weakest link. In the early days of computer networking,
networks were usually isolated to a specific company or educational
institution, so transmitting things like passwords or secrets in plain
text using the TCP protocol wasn&rsquo;t such a bad idea. Every part of the
network (cabling, switches, and routers) was contained inside a secured
physical perimeter. When connections started moving to the public
Internet, this changed.</p>
<p>TCP packets can be intercepted over the Internet, at any point between
the client and server, and these packets can easily be read if not
encrypted. Therefore, plain text protocols are highly insecure, and
should never be used to transmit sensitive information or system control
data. Even on highly secure networks with properly-configured firewalls,
it&rsquo;s a bad idea to use insecure communication methods like plain text
rlogin and telnet connections for authentication and remote control.</p>
<p>Try running <code>traceroute google.com</code> in your terminal. Look at each of
the hops between you and Google&rsquo;s CDN. Do you know who controls each of
the devices between your computer and Google? Do you trust these
operators with all of your personal or corporate secrets? Probably not.
Each of these connection points&mdash;and each network device and cable
connecting them&mdash;is a weak point exposing you to a man-in-the-middle
attack. Strong encryption is needed between your computer and the
destination if you want to ensure data security.</p>
</aside>

<h4 class="relative group">rlogin, rsh and rcp
    <div id="chap12xhtml_leanpub-auto-rlogin-rsh-and-rcp" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-rlogin-rsh-and-rcp" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p><code>rlogin</code> was introduced in BSD 4.2 in 1983, and has been distributed
with many UNIX-like systems alongside Telnet until recently. rlogin was
used widely during the 80s and much of the 90s.</p>
<p>Just like Telnet, a user could log into the remote system with a
password, but rlogin additionally allowed automatic (passwordless)
logins for users on trusted remote computers. rlogin also worked better
than telnet for remote administration, as it worked correctly with
certain characters and commands where telnet required extra translation.</p>
<p>However, like Telnet, rlogin still used plain text communications over
TCP port 513 by default. rlogin also didn&rsquo;t have many safeguards against
clients spoofing their true identities. Some of rlogin&rsquo;s intrinsic flaws
were highlighted in a 1998 report by Carnegie Mellon, <a
  href="http://resources.sei.cmu.edu/asset_files/TechnicalReport/1998_005_001_16670.pdf"
    target="_blank"
  >rlogin: The
Untold
Story</a>.</p>
<p><code>rsh</code> (&ldquo;remote shell&rdquo;) is a command line program used alongside rlogin
to execute individual shell commands remotely, and <code>rcp</code> (&ldquo;remote copy&rdquo;)
is used for remote file copies. <code>rsh</code> and <code>rcp</code> inherited the same
security problems as rlogin, since they use the same connection method
(over different ports).</p>

<h4 class="relative group">SSH
    <div id="chap12xhtml_leanpub-auto-ssh" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-ssh" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Secure Shell was created in 1995 by Finland native Tatu Ylönen, in
response to a <a
  href="http://en.wikipedia.org/wiki/Secure_Shell#Version_1.x"
    target="_blank"
  >password-sniffing
attack</a> at his
university. Seeing the flaws in plain text communication for secure
information, Tatu created Secure Shell/SSH with a strong emphasis on
encryption and security.</p>
<p>His version of SSH was developed for a few years as freeware with
liberal licensing, but as his <a
  href="http://www.ssh.com/"
    target="_blank"
  >SSH Communications Security
Corporation</a> began limiting the license and
commercializing SSH, alternative forks began to gain in popularity. The
most popular fork, OSSH, by Swedish programmer Bjoern Groenvall, was
chosen as a starting point by some developers from the OpenBSD project.</p>
<p>OpenBSD was (and still is!) a highly secure, free version of BSD UNIX,
and the project&rsquo;s developers needed a secure remote communication
protocol, so a few project members worked to <a
  href="http://www.openbsd.org/openssh/history.html"
    target="_blank"
  >clean up and improve
OSSH</a> so it could be
included in OpenBSD&rsquo;s 2.6 release in December 1999. From there, it was
quickly ported and adopted for all major versions of Linux, and is now
ubiquitous in the world of POSIX-compliant operating systems.</p>
<p>How does SSH work, and what makes it better than telnet or rlogin? It
starts with the basic connection. SSH connection encryption works
similarly to SSL for secure HTTP connections, but its authentication
layer adds more security:</p>
<ol>
<li>When you enter <code>ssh user@example.host</code> to connect to the
<code>example.host</code> server as <code>user</code>, your client and the host exchange
keys.</li>
<li>If you&rsquo;re connecting to a host the first time, or if the host&rsquo;s key
has changed since last time you connected (this happens often when
connecting via DNS rather than directly by IP), SSH will prompt you
for your approval of the host key.</li>
<li>If you have a private key in your <code>~/.ssh</code> folder matching one of
the keys in <code>~/.ssh/authorized_keys</code> on the remote system, the
connection continues to step 4. Otherwise, if password
authentication is allowed, SSH prompts you for your password. There
are other authentication methods as well, such as Kerberos, but they
are less common and not covered in this book.</li>
<li>The transferred key is used to create a session key used for the
remainder of the connection, encrypting all communication with a
cipher such as AES, 3DES, Blowfish or RC4 (&lsquo;arcfour&rsquo;).</li>
<li>The connection remains encrypted and persists until you exit out of
the remote connection (in the case of an interactive session), or
until the operation being performed (an <code>scp</code> or <code>sftp</code> file
transfer, for example) is complete.</li>
</ol>
<p>SSH uses encrypted keys to identify the client and host (which adds a
layer of security over <code>telnet</code> and <code>rlogin</code>&rsquo;s defaults), and then sets
up a per-session encrypted channel for further communication. This same
connection method is used for interactive <code>ssh</code> sessions, as well as for
services like:</p>
<ul>
<li><code>scp</code> (secure copy), SSH&rsquo;s counterpart to rlogin&rsquo;s <code>rcp</code>.</li>
<li><code>sftp</code> (secure FTP), SSH&rsquo;s client/server file transfer protocol.</li>
<li>SSH port forwarding (so you can run services securely over remote
servers).</li>
<li>SSH X11 forwarding (so you can use X windows securely).</li>
</ul>
<p>(A full list of features is available on OpenBSD&rsquo;s site: <a
  href="http://www.openbsd.org/openssh/features.html"
    target="_blank"
  >OpenSSH
Features</a>).</p>
<p>The full suite of SSH packages also includes helpful utilities like
<code>ssh-keygen</code>, which generates public/private key pairs suitable for use
when connecting via SSH. You can also install the utility <code>ssh-copy-id</code>,
which speeds up the process of manually adding your identity file to a
remote server.</p>
<p>SSH is fairly secure by default&mdash;certainly more so than telnet or
rlogin&rsquo;s default configuration&mdash;but for even greater security, there
are a few extra settings you should use (all of these settings are
configured in <code>/etc/ssh/sshd_config</code>, and require a restart of the
<code>sshd</code> service to take effect):</p>
<ol>
<li><strong>Disable password-based SSH authentication.</strong> Even though passwords
are sent in the clear, disabling password-based authentication makes
it impossible for brute-force password attacks to even be
<em>attempted</em>, even if you have the additional (and recommended) layer
of something like Fail2Ban running. Set <code>PasswordAuthentication no</code>
in the configuration.</li>
<li><strong>Disable root account remote login.</strong> You shouldn&rsquo;t log in as the
root user regardless (use <code>sudo</code> instead), but to reinforce this
good habit, disable remote root user account login by setting
<code>PermitRootLogin no</code> in the configuration. If you need to perform
actions as root, either use <code>sudo</code> (preferred), or if it&rsquo;s
absolutely necessary to work interactively as root, login with a
normal account, then <code>su</code> to the root account.</li>
<li><strong>Explicitly allow/deny SSH for users.</strong> Enable or disable SSH
access for particular users on your system with <code>AllowUsers</code> and
<code>DenyUsers</code>. To allow only &lsquo;John&rsquo; to log in, the rule would be
<code>AllowUsers John</code>. To allow any user <em>except</em> John to log in, the
rule would be <code>DenyUsers John</code>.</li>
<li><strong>Use a non-standard port.</strong> Change the default SSH port from 22 to
something more obscure, like 2849, and prevent thousands of &lsquo;script
kiddie&rsquo; attacks that look for servers responding on port 22. While
security through obscurity is no substitute for actually securing
SSH overall, it provides a slight extra layer of protection. To
change the port, set <code>Port [new-port-number]</code> in the configuration.</li>
</ol>
<p>We&rsquo;ll cover how to configure some of these particular options in SSH in
the next section.</p>

<h4 class="relative group">The evolution of SSH and the future of remote access
    <div id="chap12xhtml_leanpub-auto-the-evolution-of-ssh-and-the-future-of-remote-access" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-the-evolution-of-ssh-and-the-future-of-remote-access" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>It has been over a decade since OpenSSH became the <em>de facto</em> standard
of remote access protocols, and since then Internet connectivity has
changed dramatically. For reliable, low-latency LAN and Internet
connections, SSH is still the king due to its simplicity, speed, and
security. But in high-latency environments (think 3G or 4G mobile
network connections, or satellite uplinks), using SSH is often a painful
experience.</p>
<p>In some circumstances, just <em>establishing a connection</em> takes time.
Additionally, once connected, the delay inherent in SSH&rsquo;s TCP interface
(where every packet must reach its destination and be acknowledged
before further input will be accepted) means entering commands or
viewing progress over a high-latency connection is an exercise in
frustration.</p>
<p><a
  href="https://www.usenix.org/system/files/conference/atc12/atc12-final32.pdf"
    target="_blank"
  >Mosh</a>,
&ldquo;the mobile shell&rdquo;, a new alternative to SSH, uses SSH to establish an
initial connection, then synchronizes the following local session with a
remote session on the server via UDP.</p>
<p>Using UDP instead of TCP requires Mosh to do a little extra
behind-the-scenes work to synchronize the local and remote sessions
(instead of sending all local keystrokes over the wire serially via TCP,
then waiting for stdout and stderr to be returned, like SSH).</p>
<p>Mosh also promises better UTF-8 support than SSH, and is well supported
by all the major POSIX-like operating systems (it even runs inside
Google Chrome!).</p>
<p>It will be interesting to see where the future leads with regard to
remote terminal access, but one thing is for sure: Ansible will continue
to support the most secure, fast, and reliable connection methods to
help you build and manage your infrastructure!</p>

<h3 class="relative group">Use secure and encrypted communication
    <div id="chap12xhtml_leanpub-auto-use-secure-and-encrypted-communication" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-use-secure-and-encrypted-communication" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>We spent a lot of time discussing SSH&rsquo;s heritage and the way it works
because it is, in many ways, the foundation of a secure
infrastructure&mdash;in almost every circumstance, you will allow SSH remote
access for your servers, so it&rsquo;s important you know how it works, and
how to configure it to ensure you always administer the server securely,
over an encrypted connection.</p>
<p>Let&rsquo;s look at the security settings configured in <code>/etc/ssh/sshd_config</code>
(mentioned earlier), and how to control them with Ansible.</p>
<p>For our secure server, we want to disable password-based SSH
authentication (make sure you can already log in via your SSH key before
you do this!), disable remote root login, and change the port over which
SSH operates. Let&rsquo;s do it!</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 - hosts: example
 2   tasks:
 3     - name: Update SSH configuration to be more secure.
 4       lineinfile:
 5         dest: /etc/ssh/sshd_config
 6         regexp: &quot;{{ item.regexp }}&quot;
 7         line: &quot;{{ item.line }}&quot;
 8         state: present
 9       with_items:
10         - regexp: &quot;^PasswordAuthentication&quot;
11           line: &quot;PasswordAuthentication no&quot;
12         - regexp: &quot;^PermitRootLogin&quot;
13           line: &quot;PermitRootLogin no&quot;
14         - regexp: &quot;^Port&quot;
15           line: &quot;Port 2849&quot;
16       notify: restart ssh
17 
18   handlers:
19     - name: restart ssh
20       service: name=ssh state=restarted</code></pre>
</div>
</figure>
<p>In this extremely simple playbook, we set three options in SSH
configuration (<code>PasswordAuthentication no</code>, <code>PermitRootLogin no</code>, and
<code>Port 2849</code>) using Ansible&rsquo;s <code>lineinfile</code> module, then use a handler we
define in the <code>handlers</code> section to restart the ssh service.</p>
<aside class="warning blurb">
<p>If you change certain SSH settings, like the port for SSH, you need to
make sure Ansible&rsquo;s inventory is updated. You can explicitly define the
SSH port for a host with the option <code>ansible_ssh_port</code>, and the local
path to a private key file (identity file) with
<code>ansible_ssh_private_key_file</code>, though Ansible uses keys defined by your
<code>ssh-agent</code> setup, so typically a manual definition of the key file is
not required.</p>
</aside>

<h3 class="relative group">Disable root login and use <code>sudo</code>
    <div id="chap12xhtml_leanpub-auto-disable-root-login-and-use-sudo" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-disable-root-login-and-use-sudo" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>We&rsquo;ve already disabled root login with Ansible&rsquo;s <code>lineinfile</code> module in
the previous section, but we&rsquo;ll cover a general Linux best practice
here: don&rsquo;t use the root account if you don&rsquo;t absolutely need to use it.</p>
<p>Linux&rsquo;s <code>sudo</code> allows you (or other users) to run certain commands with
root privileges (by default&mdash;you can also run commands as another
user), ensuring you can perform actions needing elevated privileges
without requiring you to be logged in as root (or another user).</p>
<p>Using sudo also forces you to be more explicit when performing certain
actions with security implications, which is always a good thing. You
don&rsquo;t want to accidentally delete a necessary file, or turn off a
required service, which is easy to do if you&rsquo;re root.</p>
<p>In Ansible, it&rsquo;s preferred you log into the remote server with a normal
or admin-level system account, and use the <code>sudo</code> parameter with a value
of <code>yes</code> with any play or playbook include requiring elevated
privileges. For example, if restarting Apache requires elevated
privileges, you would write the play like so:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Restart Apache.
  service: name=httpd state=restarted
  sudo: yes</code></pre>
</div>
</figure>
<p>Add <code>sudo_user: [username]</code> to a task to specify a specific user account
to use with <code>sudo</code> (this will only apply if <code>sudo</code> is already set on the
task or in the playbook).</p>
<p>You can also use Ansible to control sudo&rsquo;s configuration, defining who
should have access to what commands and whether the user should be
required to enter a password, among other things.</p>
<p>As an example, set up the user <code>johndoe</code> with permission to use any
command as root via <code>sudo</code> by adding a line in the <code>/etc/sudoers</code> file
with Ansible&rsquo;s <code>lineinfile</code> module:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Add sudo group rights for deployment user.
  lineinfile:
    dest: /etc/sudoers
    regexp: &#39;^%johndoe&#39;
    line: &#39;johndoe ALL=(ALL) NOPASSWD: ALL&#39;
    state: present</code></pre>
</div>
</figure>
<p>If you&rsquo;re ever editing the sudoers file by hand, you should use
<code>visudo</code>, which validates your changes and makes sure you don&rsquo;t break
sudo when you save the changes. When using Ansible with <code>lineinfile</code>,
you have to use caution when making changes, and make sure your syntax
is correct.</p>
<p>Another way of changing the sudoers file, and ensuring the integrity of
the file, is to create a sudoers file locally, and copy it using
Ansible&rsquo;s <code>copy</code> module, with a validation command, like so:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Copy validated sudoers file into place.
  copy:
    src: sudoers
    dest: /etc/sudoers
    validate: &#39;visudo -cf %s&#39;</code></pre>
</div>
</figure>
<p>The <code>%s</code> is a placeholder for the file&rsquo;s path, and will be filled in by
Ansible before the sudoers file is copied into its final destination.
The same parameter can be passed into Ansible&rsquo;s <code>template</code> module, if
you need to copy a filled-in template to the server instead of a static
file.</p>
<aside class="tip blurb">
<p>The sudoers file syntax is very powerful and flexible, but also a bit
obtuse. Read the entire <a
  href="http://www.sudo.ws/sudoers.man.html"
    target="_blank"
  >Sudoers
Manual</a> for all the details, or
check out the <a
  href="http://www.sudo.ws/sudo/sample.sudoers"
    target="_blank"
  >sample sudoers
file</a> for some practical
examples.</p>
</aside>

<h3 class="relative group">Remove unused software, open only required ports
    <div id="chap12xhtml_leanpub-auto-remove-unused-software-open-only-required-ports" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-remove-unused-software-open-only-required-ports" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>Before the widespread use of configuration management tools for servers,
when snowflake servers were the norm, servers would become bloated with
extra software no longer in active use, open ports for old and
unnecessary services, and old configuration settings opening up
potential attack vectors.</p>
<p>If you&rsquo;re not actively using a piece of software, or there&rsquo;s an obsolete
cron task, get rid of it. If you&rsquo;re using Ansible for your entire
infrastructure, this shouldn&rsquo;t be an issue, since you could just bring
up new servers to replace old ones when you have major configuration
and/or package changes. But if not, consider adding in a &lsquo;cleanup&rsquo; role
or at least a task to remove packages that shouldn&rsquo;t be installed, like:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 - name: Remove unused packages.
2   apt: name={{ item }} state=absent purge=yes
3   with_items:
4     - apache2
5     - nano
6     - mailutils</code></pre>
</div>
</figure>
<p>With modules like <code>yum</code>, <code>apt</code>, <code>file</code>, and <code>mysql_db</code>, a <code>state=absent</code>
parameter means Ansible will remove whatever packages, files or
databases you want, and will check to make sure this is still the case
during future runs of your playbook.</p>
<p>Opening only required ports helps reduce the surface area for attack,
requiring only a few firewall rules. This will be covered fully in the
&ldquo;Use a properly-configured firewall&rdquo; section, but as an example, don&rsquo;t
leave port 25 open on your server unless your server will be used as an
SMTP relay server. Further, make sure the services you have listening on
your open ports are configured to only allow access from trusted
clients.</p>

<h3 class="relative group">Use the principle of least privilege
    <div id="chap12xhtml_leanpub-auto-use-the-principle-of-least-privilege" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-use-the-principle-of-least-privilege" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>Users, applications, and processes should only be able to access
information (files) and resources (memory, network ports, etc) necessary
for their operation.</p>
<p>Many of the other basic security measures in this chapter are
tangentially related to the principle of least privilege, but user
account configuration and file permissions are two main areas directly
related to the principle.</p>

<h4 class="relative group">User account configuration
    <div id="chap12xhtml_leanpub-auto-user-account-configuration" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-user-account-configuration" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>New user accounts, by default, have fairly limited permissions on a
Linux server. They usually have a home folder, over which they have
complete control, but any other folder or file on the system is only
available for reading, writing, or execution if the folder has group
permissions set.</p>
<p>Usually, users gain access to other files and services through two
methods:</p>
<ol>
<li>Adding the user to another group with wider access privileges.</li>
<li>Allowing the user to use the <code>sudo</code> command to execute commands and
access files as <code>root</code> or another user.</li>
</ol>
<p>For the former method, please read the next section on file permissions
to learn how to limit access. For the latter, please make sure you
understand the use of sudoers as explained earlier in this chapter.</p>

<h4 class="relative group">File permissions
    <div id="chap12xhtml_leanpub-auto-file-permissions" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-file-permissions" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Every Ansible module that deals with files has file ownership and
permission parameters available, including <code>owner</code>, <code>group</code>, and <code>mode</code>.
Almost every time you handle files (using <code>copy</code>, <code>template</code>, <code>file</code>,
etc.), you should explicitly define the correct permissions and
ownership. For example, for a configuration file (in our example, the
GitLab configuration file) that should <em>only</em> be readable or writeable
by the root user, set the following:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 - name: Configure the GitLab global configuration file.
2   file:
3     path: /etc/gitlab/gitlab.rb
4     owner: root
5     group: root
6     mode: 0600</code></pre>
</div>
</figure>
<aside class="information blurb">
<p>File permissions may seem a bit obtuse, and sometimes, they may cause
headaches. But in reality, using octal numbers to represent file
permissions is a helpful way to encapsulate a lot of configuration in
three numbers. The main thing to remember is the following: for each of
the file&rsquo;s <em>user</em>, <em>group</em>, and for <em>everyone</em> (each of the three
digits), use the following digits to represent permission levels:</p>
<figure class="code">
<div class="highlight">
<pre><code>7: rwx (read/write/execute)
6: rw- (read/write)
5: r-x (read/execute)
4: r-- (read)
3: -wx (write/execute)
2: -w- (write)
1: --x (execute)
0: --- (no permissions)</code></pre>
</div>
</figure>
<p>Basically, 4 = read, 2 = write and 1 = execute. Therefore read (4) and
write (2) is 6 in the octal representation, and read (4) and execute (1)
is 5.</p>
</aside>
<p>Less experienced admins are overly permissive, setting files and
directories to <code>777</code> to fix issues they have with their applications. To
allow one user (for example, your webserver user, <code>httpd</code> or <code>nginx</code>)
access to a directory or some files, you should consider setting the
directory&rsquo;s or files&rsquo; <em>group</em> to the user&rsquo;s group instead of giving
permissions to <em>every user on the system</em>!</p>
<p>For example, if you have a directory of web application files, the
<em>user</em> (or in Ansible&rsquo;s terminology, &ldquo;owner&rdquo;) might be your personal
user account, or a deployment or service account on the server. Set the
<em>group</em> for the files to a group the webserver user is in, and the
webserver should now be able to access the files (assuming you have the
same permissions set for the user and group, like <code>664</code>).</p>

<h3 class="relative group">Update the OS and installed software
    <div id="chap12xhtml_leanpub-auto-update-the-os-and-installed-software" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-update-the-os-and-installed-software" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>Every year, hundreds of security updates are released for the packages
running on your servers, some of them fixing critical bugs. If you don&rsquo;t
keep your server software up to date, you will be extremely vulnerable,
especially when large exposures like
<a
  href="http://heartbleed.com/"
    target="_blank"
  >Heartbleed</a> are uncovered.</p>
<p>At a minimum, you should schedule regular patch maintenance and package
upgrade windows, and make sure you test the upgrades and patches on
non-critical servers to make sure your applications work <em>before</em>
applying the same on your production infrastructure.</p>
<p>With Ansible, since you already have your entire infrastructure
described via Ansible inventories, you should be able to use a command
like the following to upgrade all installed packages on a RedHat-based
system:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible webservers -m yum -a &quot;name=* state=latest&quot;</code></pre>
</div>
</figure>
<p>On a Debian-based system, the syntax is similar:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ ansible webservers -m apt -a &quot;upgrade=dist update_cache=yes&quot;</code></pre>
</div>
</figure>
<p>The above commands will upgrade <em>everything</em> installed on your server.
Sometimes, you only want to install security-related updates, or exclude
certain packages. In those cases, you need to configure <code>yum</code> or <code>apt</code>
to tell them what to do (edit <code>/etc/yum.conf</code> for <code>yum</code> on RedHat-based
systems, or use <code>apt-mark hold [package-name]</code> to keep a certain package
at its current version on Debian-based systems).</p>

<h4 class="relative group">Automating updates
    <div id="chap12xhtml_leanpub-auto-automating-updates" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-automating-updates" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Fully automated daily or weekly package and system upgrades provide even
greater security. Not every environment or corporation can accommodate
frequent automated upgrades (especially if your application has been
known to break due to past package updates, or relies on custom builds
or specific package versions), but if you do it for your servers, it
will increase the depth of your infrastructure&rsquo;s security.</p>
<aside class="warning blurb">
<p>As mentioned in an earlier sidebar, GPG package signature checking is
enabled by default for all package-related functionality. It&rsquo;s best to
leave GPG checks in place, and import keys from trusted sources when
necessary, <em>especially</em> when using automatic updates, if you want to
prevent potentially insecure packages from being installed on your
servers!</p>
</aside>

<h4 class="relative group">Automating updates for RedHat-based systems
    <div id="chap12xhtml_leanpub-auto-automating-updates-for-redhat-based-systems" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-automating-updates-for-redhat-based-systems" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>RedHat 6 and later (and modern versions of Fedora, and RedHat
derivatives like CentOS) uses a cron-based package, <code>yum-cron</code>, for
automatic updates. For basic, set-and-forget usage, install <code>yum-cron</code>
and make sure it&rsquo;s started and set to run on system boot:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 - name: Install yum-cron.
2   yum: name=yum-cron state=present
3 
4 - name: Ensure yum-cron is running and enabled on boot.
5   service: name=yum-cron state=started enabled=yes</code></pre>
</div>
</figure>
<p>Further configuration (such as packages to exclude from automatic
updates) is done in the <code>yum.conf</code> file, at <code>/etc/yum.conf</code>.</p>

<h4 class="relative group">Automating updates for Debian-based systems
    <div id="chap12xhtml_leanpub-auto-automating-updates-for-debian-based-systems" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-automating-updates-for-debian-based-systems" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Debian and its derivatives typically use the <code>unattended-upgrades</code>
package to configure automatic updates. Like <code>yum-cron</code>, it is easy to
install, and its configuration is placed in a variety of files within
<code>/etc/apt/apt.conf.d/</code>:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 - name: Install unattended upgrades package.
 2   apt: name=unattended-upgrades state=present
 3 
 4 - name: Copy unattended-upgrades configuration files in place.
 5   template:
 6     src: &quot;../templates/{{ item }}.j2&quot;
 7     dest: &quot;/etc/apt/apt.conf.d/{{ item }}&quot;
 8     owner: root
 9     group: root
10     mode: 0644
11   with_items:
12     - 10periodic
13     - 50unattended-upgrades</code></pre>
</div>
</figure>
<p>The template files copied in the second task should look something like
the following:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 # File: /etc/apt/apt.conf.d/10periodic
2 APT::Periodic::Update-Package-Lists &quot;1&quot;;
3 APT::Periodic::Download-Upgradeable-Packages &quot;1&quot;;
4 APT::Periodic::AutocleanInterval &quot;7&quot;;
5 APT::Periodic::Unattended-Upgrade &quot;1&quot;;</code></pre>
</div>
</figure>
<p>This file provides configuration for the <code>apt</code> script that runs as part
of the unattended upgrades package, and tells apt whether to enable
unattended upgrades.</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code>1 # File: /etc/apt/apt.conf.d/50unattended-upgrades
2 Unattended-Upgrade::Automatic-Reboot &quot;false&quot;;
3 
4 Unattended-Upgrade::Allowed-Origins {
5         &quot;Ubuntu lucid-security&quot;;
6 //      &quot;Ubuntu lucid-updates&quot;;
7 };</code></pre>
</div>
</figure>
<p>This file provides further configuration for unattended upgrades, like
whether to automatically restart the server for package and kernel
upgrades requiring a reboot, or what <code>apt</code> sources should be checked for
updated packages.</p>
<aside class="tip blurb">
<p>Make sure you get notifications or check in on your servers periodically
so you know when they&rsquo;ll need a manual reboot if you have
<code>Automatic-Reboot</code> set to <code>false</code>!</p>
</aside>

<h3 class="relative group">Use a properly-configured firewall
    <div id="chap12xhtml_leanpub-auto-use-a-properly-configured-firewall" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-use-a-properly-configured-firewall" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>If you were building a secure bank vault, you wouldn&rsquo;t want to have a
many doors and windows leading into the vault. You&rsquo;d instead build
reinforced concrete walls, and have one or two strong metal doors.</p>
<p>Similarly, should close any port not explicitly required to remain open
on all your servers&mdash;whether in a DMZ in your network or open the the
entire Internet. There are dozens of different ways to manage firewalls
nowadays, from <code>iptables</code> and helpful tools like <code>ufw</code> and <code>firewalld</code>
that help make iptables configuration easier, to AWS security groups and
other external firewall services.</p>
<p>Ansible includes built-in support for configuring server firewalls with
<code>ufw</code> (common on newer Debian and Ubuntu distributions) and <code>firewalld</code>
(common on newer Fedora, RedHat, and CentOS distributions).</p>

<h4 class="relative group">Configuring a firewall with <code>ufw</code> on Debian or Ubuntu
    <div id="chap12xhtml_leanpub-auto-configuring-a-firewall-with-ufw-on-debian-or-ubuntu" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-configuring-a-firewall-with-ufw-on-debian-or-ubuntu" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>Below is an entire firewall configuration to lock down most everything
on a Debian or Ubuntu server, allowing traffic only through ports 22
(SSH), 80 (HTTP), and 123 (NTP):</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 - name: Configure open ports with ufw.
 2   ufw:
 3     rule: &quot;{{ item.rule }}&quot;
 4     port: &quot;{{ item.port }}&quot;
 5     proto: &quot;{{ item.proto }}&quot;
 6   with_items:
 7     - { rule: &#39;allow&#39;, port: 22, proto: &#39;tcp&#39; }
 8     - { rule: &#39;allow&#39;, port: 80, proto: &#39;tcp&#39; }
 9     - { rule: &#39;allow&#39;, port: 123, proto: &#39;udp&#39; }
10 
11 - name: Configure default incoming/outgoing rules with ufw.
12   ufw:
13     direction: &quot;{{ item.direction }}&quot;
14     policy: &quot;{{ item.policy }}&quot;
15     state: enabled
16   with_items:
17     - { direction: outgoing, policy: allow }
18     - { direction: incoming, policy: deny }</code></pre>
</div>
</figure>
<p>If you run a playbook with the above rules, the log into the machine (or
use the <code>ansible</code> command) and run <code>sudo ufw status verbose</code>, you should
see the configuration has been updated to the following:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ sudo ufw status verbose
Status: active
Logging: on (low)
Default: deny (incoming), allow (outgoing), disabled (routed)
New profiles: skip
<p>To                         Action      From</p>
<hr>
<p>22/tcp                     ALLOW IN    Anywhere
80/tcp                     ALLOW IN    Anywhere
123/udp                    ALLOW IN    Anywhere
22/tcp (v6)                ALLOW IN    Anywhere (v6)
80/tcp (v6)                ALLOW IN    Anywhere (v6)
123/udp (v6)               ALLOW IN    Anywhere (v6)</code></pre></p>
</div>
</figure>

<h4 class="relative group">Configuring a firewall with <code>firewalld</code> on RedHat, Fedora, or CentOS
    <div id="chap12xhtml_leanpub-auto-configuring-a-firewall-with-firewalld-on-redhat-fedora-or-centos" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-configuring-a-firewall-with-firewalld-on-redhat-fedora-or-centos" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>The same firewall configuration can be done via <code>firewalld</code> for
RedHat-based systems with similar ease:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 - name: Configure open ports with firewalld.
 2   firewalld:
 3     state: &quot;{{ item.state }}&quot;
 4     port: &quot;{{ item.port }}&quot;
 5     zone: external
 6     immediate: yes
 7     permanent: yes
 8   with_items:
 9     - { state: &#39;enabled&#39;, port: &#39;22/tcp&#39; }
10     - { state: &#39;enabled&#39;, port: &#39;80/tcp&#39; }
11     - { state: &#39;enabled&#39;, port: &#39;123/udp&#39; }</code></pre>
</div>
</figure>
<aside class="warning blurb">
<p>The <code>immediate</code> parameter was added in Ansible 1.9, and is required to
make the rules effective immediately when the <code>permanent</code> parameter is
set to <code>yes</code>. If you are running an older version of Ansible, you will
need to restart to see your changes, or set <code>permanent</code> to <code>no</code>.</p>
</aside>
<aside class="information blurb">
<p><code>firewalld</code> doesn&rsquo;t have an explicit command to allow setting default
inbound/outbound policies, but you can still use <code>iptables</code> commands or
manage the firewall via XML files inside <code>/etc/firewalld</code>.</p>
</aside>
<p>If you run <code>sudo firewall-cmd --zone=external --list-all</code>, you should
see the open ports:</p>
<figure class="code">
<div class="highlight">
<pre><code>$ sudo firewall-cmd --zone=external --list-all
external
  interfaces:
  sources:
  services: ssh
  ports: 123/udp 80/tcp 22/tcp
  masquerade: yes
  forward-ports:
  icmp-blocks:
  rich rules:</code></pre>
</div>
</figure>
<p>Some still prefer configuring firewalls with <code>iptables</code> (which is
sometimes obtuse, but is almost infinitely malleable). This approach is
used in the <code>geerlingguy.firewall</code> role on Ansible Galaxy, which
translates variables like <code>firewall_allowed_tcp_ports</code> and
<code>firewall_forwarded_tcp_ports</code> into <code>iptables</code> rules, and provides a
<code>firewall</code> service for loading firewall rules.</p>
<p>It doesn&rsquo;t really matter what method you use to control access to your
server, but the <em>principle of least privilege</em> applies here, as in most
security-related discussions: only allow access on ports absolutely
necessary for the functionality of your server, and restrict the use of
those ports to only the hosts or subnets needing access to the services
listening on the ports.</p>
<aside class="tip blurb">
<p>When you&rsquo;re building up a firewall, make sure you don&rsquo;t accidentally
lock down ports or IP addresses that will lock you out of the server
entirely, otherwise you&rsquo;ll have to connect to the server through a local
terminal connection and start over!</p>
</aside>

<h3 class="relative group">Make sure log files are populated and rotated
    <div id="chap12xhtml_leanpub-auto-make-sure-log-files-are-populated-and-rotated" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-make-sure-log-files-are-populated-and-rotated" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>Checking server logs is one of the most effective ways to not only see
what attacks have taken place on a server, but also to see trends over
time and predict high-traffic periods, potential attack vectors, and
potential catastrophe.</p>
<p>But logs are completely worthless if they aren&rsquo;t being populated with
effective data, aren&rsquo;t being monitored in any way, or are <em>the cause</em> of
an outage! Many root cause analyses conclude, &ldquo;the server&rsquo;s disk was
full because log file <em>x</em> took up all the free space&rdquo;.</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 sshd[19731]: input_userauth_request: invalid user db2admin
 2 sshd[19731]: Received disconnect from 218.78.214.9: 11: Bye Bye
 3 sshd[19732]: Invalid user jenkins from 218.78.214.9
 4 sshd[19733]: input_userauth_request: invalid user jenkins
 5 sshd[19733]: Received disconnect from 218.78.214.9: 11: Bye Bye
 6 sshd[19734]: Invalid user jenkins from 218.78.214.9
 7 sshd[19735]: input_userauth_request: invalid user jenkins
 8 sshd[19735]: Received disconnect from 218.78.214.9: 11: Bye Bye
 9 sshd[19736]: Invalid user minecraft from 218.78.214.9
10 sshd[19737]: input_userauth_request: invalid user minecraft
11 sshd[19737]: Received disconnect from 218.78.214.9: 11: Bye Bye</code></pre>
</div>
<figcaption>I have my eyes on you, 218.78.214.9…</figcaption>
</figure>
<p>Only you will know what logs are the most important to monitor on your
servers, but some of the most common ones are database slow query logs,
webserver access and error logs, authorization logs, and cron logs. Use
tools like the ELK stack (demonstrated in a cookbook in Chapter 8),
Munin, Nagios, or even a hosted service to make sure logs are populated
and monitored.</p>
<p>Additionally, you should always make sure log files are rotated and
archived (according to your infrastructure&rsquo;s needs) using a tool like
<code>logrotate</code>, and you should have monitoring enabled on log file sizes so
you have an early warning when a particular log file or directory grows
a bit too large. There are a number of <code>logrotate</code> roles on Ansible
Galaxy (e.g. <a
  href="https://galaxy.ansible.com/list#/roles/1117"
    target="_blank"
  >Nick Hammond&rsquo;s <code>logrotate</code>
role</a>) that make rotation
configuration easy.</p>

<h3 class="relative group">Monitor logins and block suspect IP addresses
    <div id="chap12xhtml_leanpub-auto-monitor-logins-and-block-suspect-ip-addresses" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-monitor-logins-and-block-suspect-ip-addresses" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>If you&rsquo;ve ever set up a new server on the public internet and enabled
SSH on port 22 with password-based login enabled, you know how quickly
the deluge of script-based logins begins. Many honeypot servers detect
hundreds or thousands of such attempts per hour.</p>
<p>If you allow password-based login (for SSH, for your web app, or for
anything else), you need to implement some form of monitoring and rate
limiting. At a most basic level, you should install a tool like
<a
  href="http://www.fail2ban.org/wiki/index.php/Main_Page"
    target="_blank"
  >Fail2Ban</a>, which
monitors log files and bans IP addresses when it detects too many
unsuccessful login attempts in a given period of time.</p>
<p>Here&rsquo;s a set of tasks you could add to your playbook to install Fail2Ban
and make sure it&rsquo;s started on either Debian or RedHat-based
distributions:</p>
<figure class="code">
<div class="highlight">
<pre class="lineno"><code> 1 - name: Install fail2ban (RedHat).
 2   yum: name=fail2ban state=present enablerepo=epel
 3   when: ansible_os_family == &#39;RedHat&#39;
 4 
 5 - name: Install fail2ban (Debian).
 6   apt: name=fail2ban state=present
 7   when: ansible_os_family == &#39;Debian&#39;
 8 
 9 - name: Ensure fail2ban is running and enabled on boot.
10   service: name=fail2ban state=started enabled=yes</code></pre>
</div>
</figure>
<p>Fail2Ban configuration is managed in a series of <code>.conf</code> files inside
<code>/etc/fail2ban</code>, and most configuration can be done by overriding
defaults in a local override file, <code>/etc/fail2ban/jail.local</code>. See the
<a
  href="http://www.fail2ban.org/wiki/index.php/MANUAL_0_8"
    target="_blank"
  >Fail2Ban manual</a> for
more information.</p>

<h3 class="relative group">Use SELinux (Security-Enhanced Linux) or AppArmor
    <div id="chap12xhtml_leanpub-auto-use-selinux-security-enhanced-linux-or-apparmor" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-use-selinux-security-enhanced-linux-or-apparmor" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>SELinux and AppArmor are two different tools which allow you to
construct security sandboxes for memory and filesystem access, so, for
example, one application can&rsquo;t easily access another application&rsquo;s
resources. It&rsquo;s a little like user and group file permissions, but
allowing far finer detail&mdash;with far more complexity.</p>
<p>You&rsquo;d be forgiven if you disabled SELinux or AppArmor in the past; both
require extra work to set up and configure for your particular servers,
especially if you&rsquo;re using less popular distribution packages (extremely
popular packages like Apache and MySQL are extremely well supported
out-of-the-box on most distributions).</p>
<p>However, both of these tools are excellent ways to add <em>defense in
depth</em> to your infrastructure. You should already have decent
configurations for firewalls, file permissions, users and groups, OS
updates, etc. But if you&rsquo;re running a web-facing
application&mdash;especially one running on a server with any other
applications&mdash;it&rsquo;s great to have the extra protection SELinux or
AppArmor provides from applications accessing things they shouldn&rsquo;t.</p>
<p>SELinux is usually installed and enabled by default on Fedora, RedHat
and CentOS systems, is available and supported on most other Linux
platforms, and is widely supported through Ansible modules, so we&rsquo;ll
cover SELinux in a bit more depth.</p>
<p>To enable SELinux in <code>targeted</code> mode (which is the most secure mode
without being almost impossible to work with), make sure the Python
SELinux library is installed, then use Ansible&rsquo;s <code>selinux</code> module:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Install Python SELinux library.
  yum: name=libselinux-python state=present
<ul>
<li>Ensure SELinux is enabled in <code>targeted</code> mode.
selinux: policy=targeted state=enforcing</code></pre></li>
</ul>
</div>
</figure>
<p>Ansible also has a <code>seboolean</code> module that allows setting SELinux
booleans. A very common setting for web servers involves setting the
<code>httpd_can_network_connect</code> boolean:</p>
<figure class="code">
<div class="highlight">
<pre><code>- name: Ensure httpd can connect to the network.
  seboolean: name=httpd_can_network_connect state=yes persistent=yes</code></pre>
</div>
</figure>
<p>The Ansible <code>file</code> module also integrates well with SELinux, allowing
the four security context fields for a file or directory to be set, one
per parameter:</p>
<ol>
<li><code>selevel</code></li>
<li><code>serole</code></li>
<li><code>setype</code></li>
<li><code>seuser</code></li>
</ol>
<p>Building custom SELinux policies for more complex scenarios is out of
the scope of this chapter, but you should be able to use tools like
<code>setroubleshoot</code>, <code>setroubleshoot-server</code>, <code>getsebool</code>, and <code>aureport</code>
to see what is being blocked, what booleans are available (and/or
enabled currently), and even get helpful notifications when SELinux
denies access to an application. Read <a
  href="https://major.io/2012/01/25/getting-started-with-selinux/"
    target="_blank"
  >Getting started with
SELinux</a> for
an excellent and concise introduction.</p>
<p>Next time you&rsquo;re tempted to disable SELinux instead of fixing the
underlying problem, spend a little time investigating the correct
boolean settings to configuring your system correctly for SELinux.</p>

<h3 class="relative group">Summary and further reading
    <div id="chap12xhtml_leanpub-auto-summary-and-further-reading" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#chap12xhtml_leanpub-auto-summary-and-further-reading" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>This chapter contains a broad overview of some Linux security best
practices, and how Ansible helps you conform to them. There is a wealth
of good information on the Internet to help you secure your servers,
including articles and publications like the following:</p>
<ul>
<li><a
  href="https://library.linode.com/security/basics"
    target="_blank"
  >Linode Library: Linux Security
Basics</a></li>
<li><a
  href="http://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers"
    target="_blank"
  >My First Five Minutes on a
Server</a></li>
<li><a
  href="http://www.cyberciti.biz/tips/linux-security.html"
    target="_blank"
  >20 Linux Server Hardening Security
Tips</a></li>
<li><a
  href="http://www.admin.com/"
    target="_blank"
  >Unix and Linux System Administration Handbook</a></li>
</ul>
<p>Much of the security configuration in this chapter is encapsulated in a
role on Ansible Galaxy, for use on your own servers: <a
  href="https://galaxy.ansible.com/list#/roles/1030"
    target="_blank"
  >security role by
geerlingguy</a>.</p>
<figure class="code">
<div class="highlight">
<pre><code> _____________________________________
/ Bad planning on your part does not  \
| constitute an emergency on my part. |
\ (Proverb)                           /
 -------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||</code></pre>
</div>
</figure>
:::
<p>[]{#chap13.xhtml}</p>
<p>::: {}</p>

          
          
          
        </div>
        
        

        

        

      </div>

      
      
        
        
          
          
        
        
        
        <script
          type="text/javascript"
          src="/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js"
          integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="
          data-oid="views_tech notes/RHCE/Ansible4Devops/Chapter 10 - Server Security and Ansible.md"
          data-oid-likes="likes_tech notes/RHCE/Ansible4Devops/Chapter 10 - Server Security and Ansible.md"></script>
      
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      

      
    </footer>
  </article>

        


  






<div
  id="scroll-to-top"
  class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200">
  <a
    href="#the-top"
    class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top"
    title="Scroll to top">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
      
      
        
      
      
      
      
      <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 overflow-x-auto py-2">
        <ul class="flex list-none flex-row">
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 me-4">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href=""
                title="">
                
                
              </a>
            </li>
          
        </ul>
      </nav>
    
  
  <div class="flex items-center justify-between">
    
    
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          &copy;
          2025
          David Thomas
      </p>
    

    
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
  <script
    type="text/javascript"
    src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js"
    integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="http://localhost:1313/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
