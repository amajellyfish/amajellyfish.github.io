<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="false"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="en">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  
    <title>Manage Users and Groups with Ansible &middot; </title>
    <meta name="title" content="Manage Users and Groups with Ansible &middot; ">
  

  
  
    <meta name="description" content="How to Manage Users and Groups with Ansible">
  
  
  
  
  <link rel="canonical" href="http://localhost:1313/tech/ansible/manage-users-and-groups-with-ansible/">
  

  
  
    <meta name="author" content="David Thomas">
  
  

  
  <meta property="og:url" content="http://localhost:1313/tech/ansible/manage-users-and-groups-with-ansible/">
  <meta property="og:title" content="Manage Users and Groups with Ansible">
  <meta property="og:description" content="How to Manage Users and Groups with Ansible">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="tech">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Manage Users and Groups with Ansible">
  <meta name="twitter:description" content="How to Manage Users and Groups with Ansible">

  
  
  
  
    
      
    
  
    
      
    
  
    
      
    
  
  
    
  

  
  
  
  
  
  

  

  
  
  
  
  
  
  
    
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.278a55d3e0b39215730b0c642c7c22cc020054272d3850d92c957cddf6209cf18e0ed01f082db397c8c048c30e727b44ca408c350384ca92d5f37c62d008cbd8.css"
    integrity="sha512-J4pV0&#43;CzkhVzCwxkLHwizAIAVCctOFDZLJV83fYgnPGODtAfCC2zl8jASMMOcntEykCMNQOEypLV83xi0AjL2A==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js"
    integrity="sha512-b0EXSzoFtoCCD&#43;CMrb&#43;l&#43;3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script>
  
  
  
  
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
  
    
  
  
    
  
  
    
  
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js"
      integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP&#43;pSqMXxm6JPOUeAg=="
      data-copy="Copy"
      data-copied="Copied"></script>
  

  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>


























  

  

  

  

  





  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "",
    "name": "Manage Users and Groups with Ansible",
    "headline": "Manage Users and Groups with Ansible",
    "description": "How to Manage Users and Groups with Ansible",
    "abstract": "\u003ch2 class=\u0022relative group\u0022\u003eUsing Ansible Modules to Manage Users and Groups\n    \u003cdiv id=\u0022using-ansible-modules-to-manage-users-and-groups\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#using-ansible-modules-to-manage-users-and-groups\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h2\u003e\n\u003cul\u003e\n\u003cli\u003emanagement of the user and group accounts and their direct properties.\u003c\/li\u003e\n\u003cli\u003emanagement of sudo privilege escalation\u003c\/li\u003e\n\u003cli\u003eSetting up SSH connections and setting user passwords\u003c\/li\u003e\n\u003c\/ul\u003e\n\n\u003ch4 class=\u0022relative group\u0022\u003eModules\n    \u003cdiv id=\u0022modules\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none\u0022\u003e\n        \u003ca class=\u0022text-primary-300 dark:text-neutral-700 !no-underline\u0022 href=\u0022#modules\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e\n    \n\u003c\/h4\u003e\n\u003cp\u003euser\u003c\/p\u003e",
    "inLanguage": "en",
    "url" : "http://localhost:1313/tech/ansible/manage-users-and-groups-with-ansible/",
    "author" : {
      "@type": "Person",
      "name": "David Thomas"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2783"
  }]
  </script>



  
  

  
  

  
  

  
  
    
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
      <script>

    const firebaseConfig = {
      apiKey: "AIzaSyApsKLCbGb5fkkrzxABOtl3-OUuBcRPVsc",
      authDomain: "davidwrites-89dd7.firebaseapp.com",
      projectId: "davidwrites-89dd7",
      storageBucket: "davidwrites-89dd7.firebasestorage.app",
      messagingSenderId: "433139099634",
      appId: "1:433139099634:web:c14275555bd7171e6c6d6b",
      measurementId: "G-XX5507B82W"
    };

        var app = firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var auth = firebase.auth();

      </script>
    
  

  
  
</head>







  
    
  







  
    
  






  
  
  <body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        Skip to main content
      </a>
    </div>
    
    
      













<div
  class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0">
  
  
    
    
      <div>
        <a href="/" class="flex">
          <span class="sr-only"></span>
          
            <img
              src="/img/logo.png"
              width="200"
              height="37"
              class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom"
              alt="">
          
        </a>
      </div>
    

  <div class="flex flex-1 items-center justify-between">
    <nav class="flex space-x-3">
      
    </nav>
    
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">
    
      
        
  <a
  href="/tech/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Tech"
  title="">
  
  
    <p class="text-base font-medium">
      Tech
    </p>
  
</a>



      
        
  <a
  href="/notes/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Notes"
  title="Book Notes &amp; Reviews">
  
  
    <p class="text-base font-medium">
      Notes
    </p>
  
</a>



      
        
  <a
  href="/articles/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Articles"
  title="Articles">
  
  
    <p class="text-base font-medium">
      Articles
    </p>
  
</a>



      
        
  <a
  href="/now/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Now"
  title="Now">
  
  
    <p class="text-base font-medium">
      Now
    </p>
  
</a>



      
        
  <a
  href=""
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  
  title="">
  
  
</a>



      
    

    

    

    
      <button
        id="search-button"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </nav>

    
  <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">
    <span></span>

    

    

    
      <button
        id="search-button-mobile"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
  </div>

  </div>
  
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]">
          <ul
            class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
              </span>
            </li>

            
              
  <li class="mt-1">
  <a
    href="/tech/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Tech"
    title="">
    
    
      <p class="text-bg font-bg">
        Tech
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/notes/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Notes"
    title="Book Notes &amp; Reviews">
    
    
      <p class="text-bg font-bg">
        Notes
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/articles/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Articles"
    title="Articles">
    
    
      <p class="text-bg font-bg">
        Articles
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/now/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Now"
    title="Now">
    
    
      <p class="text-bg font-bg">
        Now
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href=""
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    
    title="">
    
    
  </a>
</li>



            

          </ul>
          
        </div>
      
    </div>
  </div>

</div>




  <script>
    (function () {
      var $mainmenu = $(".main-menu");
      var path = window.location.pathname;
      $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
        $(e).children("p").addClass("active");
      });
    })();
  </script>


    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Manage Users and Groups with Ansible
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  
    
  

  

  

  

  

  

  

  

  

  

  


  <div class="flex flex-row flex-wrap items-center">
    
    

    
    
  </div>

  

  
  

  
  



      </div>
      
        
  
  
  
  
  
  

  

  

  

  

      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky lg:top-10">
            
              <details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#using-ansible-modules-to-manage-users-and-groups">Using Ansible Modules to Manage Users and Groups</a>
      <ul>
        <li>
          <ul>
            <li><a href="#modules">Modules</a></li>
            <li><a href="#managing-users-and-groups">Managing Users and Groups</a></li>
            <li><a href="#managing-sudo">Managing sudo</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#managing-ssh-connections">Managing SSH Connections</a>
      <ul>
        <li>
          <ul>
            <li><a href="#understanding-ssh-connection-management-requirements">Understanding SSH Connection Management Requirements</a></li>
            <li><a href="#lookup-plug-in">Lookup Plug-in</a></li>
            <li><a href="#setting-up-ssh-user-keys">Setting Up SSH User Keys</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#managing-encrypted-passwords">Managing Encrypted Passwords</a>
      <ul>
        <li>
          <ul>
            <li><a href="#understanding-encrypted-passwords">Understanding Encrypted Passwords</a></li>
            <li><a href="#generating-encrypted-passwords">Generating Encrypted Passwords</a></li>
            <li><a href="#using-an-alternative-approach">Using an Alternative Approach</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#using-ansible-modules-to-manage-users-and-groups">Using Ansible Modules to Manage Users and Groups</a>
      <ul>
        <li>
          <ul>
            <li><a href="#modules">Modules</a></li>
            <li><a href="#managing-users-and-groups">Managing Users and Groups</a></li>
            <li><a href="#managing-sudo">Managing sudo</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#managing-ssh-connections">Managing SSH Connections</a>
      <ul>
        <li>
          <ul>
            <li><a href="#understanding-ssh-connection-management-requirements">Understanding SSH Connection Management Requirements</a></li>
            <li><a href="#lookup-plug-in">Lookup Plug-in</a></li>
            <li><a href="#setting-up-ssh-user-keys">Setting Up SSH User Keys</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#managing-encrypted-passwords">Managing Encrypted Passwords</a>
      <ul>
        <li>
          <ul>
            <li><a href="#understanding-encrypted-passwords">Understanding Encrypted Passwords</a></li>
            <li><a href="#generating-encrypted-passwords">Generating Encrypted Passwords</a></li>
            <li><a href="#using-an-alternative-approach">Using an Alternative Approach</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>


<script>
  (function () {
    'use strict'

    const SCROLL_OFFSET_RATIO = 0.33
    const TOC_SELECTOR = '#TableOfContents'
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false

    function getActiveAnchorId(anchors, offsetRatio) {
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...document.querySelectorAll('#TableOfContents a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => link.getAttribute('href').substring(1)))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      for (let i = anchors.length - 1; i >= 0; i--) {
        const top = anchors[i].getBoundingClientRect().top + window.scrollY
        if (top <= threshold && tocIds.has(anchors[i].id)) {
          return anchors[i].id
        }
      }
      return anchors.find(anchor => tocIds.has(anchor.id))?.id || ''
    }

    function updateTOC({ toc, anchors, links, scrollOffset, collapseInactive }) {
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) return

      links.forEach(link => {
        const isActive = link.getAttribute('href') === `#${activeId}`
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        let el = activeLink
        while (el && el !== toc) {
          if (el.tagName === 'UL') el.style.display = ''
          if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
          el = el.parentElement
        }
      }
    }

    function initTOC() {
      const toc = document.querySelector(TOC_SELECTOR)
      if (!toc) return

      const collapseInactive = true
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
        })
      })

      const config = {
        toc,
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      window.addEventListener('scroll', () => updateTOC(config), { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      updateTOC(config)
    }

    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', initTOC)
      : initTOC()
  })()
</script>


            
          </div>
        </div>
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          
<h2 class="relative group">Using Ansible Modules to Manage Users and Groups
    <div id="using-ansible-modules-to-manage-users-and-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#using-ansible-modules-to-manage-users-and-groups" aria-label="Anchor">#</a>
    </span>
    
</h2>
<ul>
<li>management of the user and group accounts and their direct properties.</li>
<li>management of sudo privilege escalation</li>
<li>Setting up SSH connections and setting user passwords</li>
</ul>

<h4 class="relative group">Modules
    <div id="modules" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#modules" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>user</p>
<ul>
<li>manage users and their base properties</li>
</ul>
<p>group</p>
<ul>
<li>Manage groups and their properties</li>
</ul>
<p>pamd</p>
<ul>
<li>Manage advanced authentication configuration through linux pluggable authentication modules (PAM)</li>
</ul>
<p>known_hosts</p>
<ul>
<li>manage ssh known hosts</li>
</ul>
<p>authorized_key</p>
<ul>
<li>copy authorized key to a managed host</li>
</ul>
<p>lineinfile</p>
<ul>
<li>modify config file</li>
</ul>

<h4 class="relative group">Managing Users and Groups
    <div id="managing-users-and-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#managing-users-and-groups" aria-label="Anchor">#</a>
    </span>
    
</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span>---<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">creating a user and group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">setup the group account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">group</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">students</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">setup the user account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">anna</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">create_home</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">wheel,students</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">generate_ssh_key</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ssh_key_bits</span><span class="p">:</span><span class="w"> </span><span class="m">2048</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ssh_key_file</span><span class="p">:</span><span class="w"> </span><span class="l">.ssh/id_rsa</span><span class="w">
</span></span></span></code></pre></div><p><strong>group</strong> argument is</p>
<ul>
<li>used to specify the primary group of the user.</li>
</ul>
<p><strong>groups</strong> argument is</p>
<ul>
<li>
<p>used to make the user a member of additional groups.</p>
</li>
<li>
<p>While using the <strong>groups</strong> argument for existing users, make sure to include the <strong>append</strong> argument as well.</p>
</li>
<li>
<p>Without <strong>append</strong>, all current secondary group assignments are overwritten.</p>
</li>
</ul>
<p>Also notice that the user module has some options that cannot normally be managed with the Linux <strong>useradd</strong> command. The module can also be used to generate an SSH key and specify its properties.</p>

<h4 class="relative group">Managing sudo
    <div id="managing-sudo" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#managing-sudo" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>No Ansible module specifically targets managing a sudo configuration</p>
<p>two options:</p>
<ol>
<li>You can use the template module to create a sudo configuration file in the directory /etc/sudoers.d.
<ul>
<li>Using such a file is recommended because the file is managed independently, and as such, there is no risk it will be overwritten by an RPM update.</li>
</ul>
</li>
<li>The alternative is to use the lineinfile module to manage the /etc/sudoers main configuration file directly.</li>
</ol>
<p>Users are created and added to a sudo file that is generated from a template:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="l">ansible@control rhce8-book]$ cat vars/sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sudo_groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">developers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groupid</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admins</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groupid</span><span class="p">:</span><span class="w"> </span><span class="m">5001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dbas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groupid</span><span class="p">:</span><span class="w"> </span><span class="m">5002</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groupid</span><span class="p">:</span><span class="w"> </span><span class="m">5003</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groupid</span><span class="p">:</span><span class="w"> </span><span class="m">5004</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="l">ansible@control rhce8-book]$ cat vars/users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">linda</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lori</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lisa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lucy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>vars/users file defines users and the groups they should be a member of.</li>
<li>vars/sudo file defines new groups and, for each of these groups, sets a sudo parameter, which will be used in the template file:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">{<span class="l">% for item in sudo_groups %}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>{<span class="l">% if item.sudo %}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">%{{ item.name}} ALL=(ALL:ALL) NOPASSWD:ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>{<span class="l">% endif %}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>{<span class="l">% endfor %}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>a <strong>for</strong> loop is used to walk through all items that have been defined in the <strong>sudo_groups</strong> variable in the vars/sudo file.</li>
<li>for each of these groups an <strong>if</strong> statement is used to check the value of the Boolean variable sudo. If this variable is set to the Boolean value true, the group is added as a sudo group to the /etc/sudoers.d/sudogroups file.</li>
</ul>
<p><strong>Listing 13-4</strong> Managing sudo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">    </span>---<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configure sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vars_files</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">vars/sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">vars/users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add groups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">group</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ sudo_groups }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.groups }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ users }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow group members in sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">listing133.j2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/sudoers.d/sudogroups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">validate</span><span class="p">:</span><span class="w"> </span><span class="l">‘visudo -cf %s’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="m">0440</span><span class="w">
</span></span></span></code></pre></div>
<h2 class="relative group">Managing SSH Connections
    <div id="managing-ssh-connections" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#managing-ssh-connections" aria-label="Anchor">#</a>
    </span>
    
</h2>
<ul>
<li>How to provide for SSH keys for new users in such a way that users are provided with SSH keys without having to set them up themselves.</li>
<li>To do this, you use the authorized_key module together with the <strong>generate_ssh_key</strong> argument to the user module.</li>
</ul>

<h4 class="relative group">Understanding SSH Connection Management Requirements
    <div id="understanding-ssh-connection-management-requirements" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#understanding-ssh-connection-management-requirements" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>How SSH keys are used in the communication process between a user and an SSH server:</p>
<ol>
<li>The user initiates a session with an SSH server.</li>
<li>The server sends back an identification token that is encrypted with the server private key to the user.</li>
<li>The user uses the server’s public key fingerprint, which is stored in the ~/.ssh/known_hosts file to verify the identification token.</li>
<li>If no public key fingerprint was stored yet in the ~/.ssh/known_hosts file, the user is prompted to store the remote server identity in the ~/.ssh/known_hosts file. At this point there is no good way to verify whether the user is indeed communicating with the intended server.</li>
<li>After establishing the identity of the remote server, the user can either send over a password or generate an authentication token that is based on the user’s private key.</li>
<li>If an authentication token that was based on the user’s private key is sent over, this token is received by the server, which tries to match it against the user’s public key that is stored in the ~/.ssh/authorized_keys file.</li>
<li>After the incoming authentication token to the stored user public key in the authorized_keys file is matched, the user is authenticated. If this authentication fails and password authentication is allowed, password authentication is attempted next.</li>
</ol>
<p>In the authentication procedure, two key pairs play an important role. First, there is the server’s public/private key pair, which is used to establish a secure connection.
To manage the host public key, you can use the Ansible known_hosts module. Next, there is the user’s public/private key pair, which the user uses to authenticate. To manage the public key in this key pair, you can use the Ansible authorized_key module.</p>

<h4 class="relative group">Lookup Plug-in
    <div id="lookup-plug-in" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#lookup-plug-in" aria-label="Anchor">#</a>
    </span>
    
</h4>
<ul>
<li>Enables Ansible to access data from outside sources.</li>
<li>Read the file system or contact external datastores and services.</li>
<li>Ran on the Ansible control host.</li>
<li>Results are usually stored in variables or templates.</li>
</ul>
<p>Set the value of a variable to the contents of a file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple demo with the lookup plugin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file_contents</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{lookup(‘file’, ‘/etc/hosts’)}}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l">file_contents</span><span class="w">
</span></span></span></code></pre></div>
<h4 class="relative group">Setting Up SSH User Keys
    <div id="setting-up-ssh-user-keys" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#setting-up-ssh-user-keys" aria-label="Anchor">#</a>
    </span>
    
</h4>
<ul>
<li>To use SSH to connect to a user account on a managed host you can copy over the local user public key to the remote user ~/.ssh/authorized_keys file.</li>
<li>If the target authorized_keys file just has to contain one single key, you could use the copy module to copy it over.</li>
<li>To manage multiple keys in the remote user authorized_keys file, you’re better off using the authorized_key module.</li>
</ul>
<p>authorized_key module</p>
<ul>
<li>Copy the authorized_key for a user</li>
<li>/home/ansible/.ssh/id_rsa.pub is used as the source.</li>
<li>lookup plug-in is used to refer to the file contents that should be used:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorized_key simple demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">copy authorized key for ansible user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">authorized_key</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">ansible</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(‘file’, ‘/home/ansible/.ssh/id_rsa.pub’) }}&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Do the same for multiple users:
vars/users</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">linda</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lori</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lisa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">lucy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span></code></pre></div><p>vars/groups</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">usergroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">groupname</span><span class="p">:</span><span class="w"> </span><span class="l">sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">groupname</span><span class="p">:</span><span class="w"> </span><span class="l">account</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configure users with SSH keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">vars/users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">vars/groups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add groups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.groupname }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ usergroups }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.groups }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ users }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add SSH public keys</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">authorized_key</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(‘file’, ‘files/’+ item.username + ‘/id_rsa.pub’) }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ users }}&#34;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>
<p>authorized_key module is set up to work on <strong>item.username</strong>, using a <strong>loop</strong> on the <strong>users</strong> variable.</p>
</li>
<li>
<p>The id_rsa.pub files that have to be copied over are expected to exist in the files directory, which exists in the current project directory.</p>
</li>
<li>
<p>Copying over the user public keys to the project directory is a solution because the authorized_keys module cannot read files from a hidden directory.</p>
</li>
<li>
<p>It would be much nicer to use <strong>key: “{{ lookup(‘file’, ‘/home/’+ item.username + ‘.ssh/id_rsa.pub’) }}”</strong>, but that doesn’t work.</p>
</li>
<li>
<p>In the first task you create a local user, including an SSH key.</p>
</li>
<li>
<p>Because an SSH key should include the name of the user and host that it applies to, you need to use the <strong>generate_ssh_key</strong> argument, as well as the <strong>ssh_key_comment</strong> argument to write the correct comment into the public key.</p>
</li>
<li>
<p>Without this content, the key will have generic content and not be considered a valid key.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create the local user, including SSH key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">generate_ssh_key</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ssh_key_comment</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>After creating the SSH keys this way, you aren’t able to fetch the key directly from the user home directory.</li>
<li>To fix that problem, you create a directory with the name of the user in the project directory and copy the user public key from there by using the shell module:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create a directory to store the file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">copy the local user ssh key to temporary {{ username }} key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">‘cat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pub’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">verify that file exists</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">ls -l {{ username }}/</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Next, in the second play you create the remote user and use the authorized_key module to copy the key from the temporary directory to the new user home directory.</li>
</ul>
<p><strong>Exercise 13-2 Managing Users with SSH Keys</strong>
Steps</p>
<ol>
<li>Create a user on localhost.</li>
<li>Use the appropriate arguments to create the SSH public/private key pair according to the required format.</li>
<li>Make sure the public key is copied to a directory where it can be accessed.</li>
<li>Uses the user module to create the user, as well as the authorized_key module to fetch the key from localhost and copy it to the .ssh/authorized_keys file in the remote user home directory.</li>
<li>Use the command <strong>ansible-playbook exercise132.yaml -e username=radha</strong> to create the user radha with the appropriate SSH keys.</li>
<li>To verify it has worked, use <strong>sudo su - radha</strong> on the control host, and type the command <strong>ssh ansible1</strong>. You should able to log in without entering a password.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prepare localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create the local user, including SSH key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">generate_ssh_key</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ssh_key_comment</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create a directory to store the file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">copy the local user ssh key to temporary {{ username }} key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">‘cat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pub’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">verify that file exists</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">ls -l {{ username }}/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">setup remote host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create remote user, no need for SSH key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use authorized_key to set the password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">authorized_key</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ username }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(‘file’, ‘./’+ username +’/id_rsa.pub’) }}&#34;</span><span class="w">
</span></span></span></code></pre></div>
<h2 class="relative group">Managing Encrypted Passwords
    <div id="managing-encrypted-passwords" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#managing-encrypted-passwords" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>When managing users in Ansible, you probably want to set user passwords
as well. The challenge is that you cannot just enter a password as the
value to the <strong>password:</strong> argument in the user module because the user
module expects you to use an encrypted string.</p>

<h4 class="relative group">Understanding Encrypted Passwords
    <div id="understanding-encrypted-passwords" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#understanding-encrypted-passwords" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>When a user creates a password, it is encrypted. The hash of the
encrypted password is stored in the /etc/shadow file, a file that is
strictly secured and accessible only with root privileges. The string
looks like $6$237687687/$9809erhb8oyw48oih290u09. In this string are
three elements, which are separated by $ signs:</p>
<p>• The hashing algorithm that was used</p>
<p>• The random salt that was used to encrypt the password</p>
<p>• The encrypted hash of the user password</p>
<p>When a user sets a password, a random salt is used to prevent two users
who have identical passwords from having identical entries in
/etc/shadow. The salt and the unencrypted password are combined and
encrypted, which generates the encrypted hash that is stored in
/etc/shadow. Based on this string, the password that the user enters can
be verified against the password field in /etc/shadow, and if it
matches, the user is authenticated.</p>

<h4 class="relative group">Generating Encrypted Passwords
    <div id="generating-encrypted-passwords" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#generating-encrypted-passwords" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>When you&rsquo;re creating users with the Ansible user module, there is a
password option. This option is not capable of generating an encrypted
password. It expects an encrypted password string as its input. That
means an external utility must be used to generate an encrypted string.
This encrypted string must be stored in a variable to create the
password. Because the variable is basically the user password, the
variable should be stored securely in, for example, an Ansible Vault
secured file.</p>
<p>To generate the encrypted variable, you can choose to create the
variable before creating the user account. Alternatively, you can run
the command to create the variable in the playbook, use <strong>register</strong> to
write the result to a variable, and use that to create the encrypted
user. If you want to generate the variable beforehand, you can use the
following ad hoc command:</p>
<pre><code>ansible localhost -m debug -a &quot;msg={{ ‘password’ | password_hash(‘sha512’,’myrandomsalt’) }}&quot;
</code></pre>
<p>This command generates the encrypted string as shown in <a
  href="#ch13.xhtml#list13_11">Listing
13-11</a>, and this string can next be used in a
playbook. An example of such a playbook is shown in <a
  href="#ch13.xhtml#list13_12">Listing
13-12</a>.</p>
<p><strong>Listing 13-11</strong> Generating the Encrypted Password String</p>
<p>::: pre_1
[ansible@control ~]$ ansible localhost -m debug -a &ldquo;msg={{ ‘password’ | password_hash(‘sha512’,’myrandomsalt’) }}&rdquo;
localhost | SUCCESS =&gt; {
&ldquo;msg&rdquo;: &ldquo;$6$myrandomsalt$McEB.xAVUWe0./6XqZ8n/7k9VV/Gxndy9nIMLyQAiPnhyBoToMWbxX2vA4f.Uv9PKnPRaYUUc76AjLWVAX6U10&rdquo;
}
:::</p>
<p><strong>Listing 13-12</strong> Sample Playbook That Creates an Encrypted User
Password</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">    </span>---<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create user with encrypted pass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible2.example.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$6$myrandomsalt$McEB.xAVUWe0./6XqZ8n/7k9VV/Gxndy9nIMLyQAiPnhyBoToMWbxX2vA4f.Uv9PKnPRaYUUc76AjLWVAX6U10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create the user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">anna</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ password }}&#34;</span><span class="w">
</span></span></span></code></pre></div><p>The method that is used here works but is not elegant. First, you need
to generate the encrypted password manually beforehand. Also, the
encrypted password string is used in a readable way in the playbook. By
seeing the encrypted password and salt, it&rsquo;s possible to get to the
original password, which is why the password should not be visible in
the playbook in a secure environment.</p>
<p>In <a
  href="#ch13.xhtml#exe13_3">Exercise 13-3</a> you create a playbook that
prompts for the user password and that uses the debug module, which was
used in <a
  href="#ch13.xhtml#list13_11">Listing 13-11</a> inside the playbook,
together with register, so that the password no longer is readable in
clear text. Before looking at <a
  href="#ch13.xhtml#exe13_3">Exercise 13-3</a>,
though, let&rsquo;s first look at an alternative approach that also works.</p>
<p>The procedure to use encrypted passwords while creating user accounts is
documented in the Frequently Asked Questions from the Ansible
documentation. Because the documentation is available on the exam, make
sure you know where to find this information! Search for the item &ldquo;How
do I generate encrypted passwords for the user module?&rdquo;</p>

<h4 class="relative group">Using an Alternative Approach
    <div id="using-an-alternative-approach" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#using-an-alternative-approach" aria-label="Anchor">#</a>
    </span>
    
</h4>
<p>As has been mentioned on multiple occasions, in Ansible often different
solutions exist for the same problem. And sometimes, apart from the most
elegant solution, there&rsquo;s also a quick-and-dirty solution, and that
counts for setting a user-encrypted password as well. Instead of using
the solution described in the previous section, &ldquo;Generating Encrypted
Passwords,&rdquo; you can use the Linux command <strong>echo password | passwd
--stdin</strong> to set the user password. <a
  href="#ch13.xhtml#list13_13">Listing
13-13</a> shows how to do this. Notice this example
focuses on how to do it, not on security. If you want to make the
playbook more secure, it would be nice to store the password in Ansible
Vault.</p>
<p><strong>Listing 13-13</strong> Setting the User Password: Alternative Solution</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">    </span>---<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create user with encrypted password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">ansible3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">mypassword</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">anna</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configure user {{ user }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ user }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">wheel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">set a password for {{ user }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">‘echo {{ password }} | passwd --stdin {{ user }}’</span><span class="w">
</span></span></span></code></pre></div><p>::: box
<strong>Exercise 13-3 Creating Users with Encrypted Passwords</strong></p>
<p>1. Use your editor to create the file exercise133.yaml.</p>
<p>2. Write the play header as follows:</p>
<pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: create user with encrypted password
  hosts: ansible3
  vars_prompt:
  - name: passw
    prompt: which password do you want to use
  vars:
    user: sharon
  tasks:
</code></pre><p>3. Add the first task that uses the debug module to generate the
encrypted password string and register to store the string in the
variable <strong>mypass</strong>:</p>
<pre tabindex="0"><code class="language-pre1" data-lang="pre1">- debug:
    msg: &#34;{{ ‘{{ passw }}’| password_hash(‘sha512’,’myrandomsalt’) }}&#34;
  register: mypass
</code></pre><p>4. Add a debug module to analyze the exact format of the registered
variable:</p>
<pre tabindex="0"><code class="language-pre1" data-lang="pre1">- debug:
    var: mypass
</code></pre><p>5. Use <strong>ansible-playbook exercise133.yaml</strong> to run the playbook the
first time so that you can see the exact name of the variable that you
have to use. This code shows that the <strong>mypass.msg</strong> variable contains
the encrypted password string (see <a
  href="#ch13.xhtml#list13_14">Listing
13-14</a>).</p>
<p><strong>Listing 13-14</strong> Finding the Variable Name Using debug</p>
<p>::: pre_1</p>
<pre tabindex="0"><code class="language-pre1" data-lang="pre1">TASK [debug] *******************************************************************
ok: [ansible2] =&gt; {
    &#34;mypass&#34;: {
        &#34;changed&#34;: false,
        &#34;failed&#34;: false,
        &#34;msg&#34;: &#34;$6$myrandomsalt$Jesm4QGoCGAny9ebP85apmh0/uUXrj0louYb03leLoOWSDy/imjVGmcODhrpIJZt0rz.GBp9pZYpfm0SU2/PO.&#34;
    }
}
</code></pre><p>:::</p>
<p>6. Based on the output that you saw with the previous command, you can
now use the user module to refer to the password in the right way. Add
the following task to do so:</p>
<pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create the user
  user:
    name: &#34;{{ user }}&#34;
    password: &#34;{{ mypass.msg }}&#34;
</code></pre><p>7. Use <strong>ansible-playbook exercise133.yaml</strong> to run the playbook and
verify its output.
:::</p>

          
          
          
        </div>
        
        

        

        

      </div>

      
      
        
        
          
          
        
        
        
        <script
          type="text/javascript"
          src="/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js"
          integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="
          data-oid="views_tech/ansible/Manage Users and Groups with Ansible.md"
          data-oid-likes="likes_tech/ansible/Manage Users and Groups with Ansible.md"></script>
      
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      

      
    </footer>
  </article>

        


  






<div
  id="scroll-to-top"
  class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200">
  <a
    href="#the-top"
    class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top"
    title="Scroll to top">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
      
      
        
      
      
      
      
      <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 overflow-x-auto py-2">
        <ul class="flex list-none flex-row">
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 me-4">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href=""
                title="">
                
                
              </a>
            </li>
          
        </ul>
      </nav>
    
  
  <div class="flex items-center justify-between">
    
    
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          &copy;
          2025
          David Thomas
      </p>
    

    
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
  <script
    type="text/javascript"
    src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js"
    integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="http://localhost:1313/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
